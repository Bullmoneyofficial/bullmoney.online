// BULLMONEY GPU MANAGER v3.0 (auto-generated by boost.py)
// Manages WebGL contexts and GPU resources to prevent crashes
(function(){
'use strict';
var w=window,d=document;
var GM=w.__BM_GPU_MANAGER__={contexts:[],maxContexts:8,activeContexts:0,contextPool:[],gpuInfo:{}};

// ─── 201. GPU Capability Detection ───
(function detectGPU(){
  try{
    var c=d.createElement('canvas');
    var gl=c.getContext('webgl2')||c.getContext('webgl');
    if(!gl){GM.gpuInfo={supported:false};return;}
    GM.gpuInfo.supported=true;
    GM.gpuInfo.version=gl.getParameter(gl.VERSION);
    GM.gpuInfo.vendor=gl.getParameter(gl.VENDOR);
    var dbg=gl.getExtension('WEBGL_debug_renderer_info');
    if(dbg){
      GM.gpuInfo.renderer=gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL);
      GM.gpuInfo.gpuVendor=gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL);
    }
    GM.gpuInfo.maxTextureSize=gl.getParameter(gl.MAX_TEXTURE_SIZE);
    GM.gpuInfo.maxViewport=gl.getParameter(gl.MAX_VIEWPORT_DIMS);
    GM.gpuInfo.maxRenderBufferSize=gl.getParameter(gl.MAX_RENDERBUFFER_SIZE);
    GM.gpuInfo.webgl2=!!c.getContext('webgl2');

    // Detect known weak GPUs
    var renderer=(GM.gpuInfo.renderer||'').toLowerCase();
    GM.gpuInfo.isIntegrated=/intel|mesa|swiftshader|llvmpipe|softpipe/i.test(renderer);
    GM.gpuInfo.isAppleGPU=/apple/i.test(renderer);
    GM.gpuInfo.isNvidia=/nvidia|geforce|quadro|rtx|gtx/i.test(renderer);
    GM.gpuInfo.isAMD=/amd|radeon|rx\s/i.test(renderer);

    // Set max contexts based on GPU
    if(GM.gpuInfo.isIntegrated||!GM.gpuInfo.webgl2){GM.maxContexts=4;}
    else if(GM.gpuInfo.isAppleGPU){GM.maxContexts=6;}
    else{GM.maxContexts=8;}

    // Lossy context detection
    c.addEventListener('webglcontextlost',function(){
      GM.activeContexts=Math.max(0,GM.activeContexts-1);
      w.dispatchEvent(new CustomEvent('bullmoney-webgl-context-lost'));
    });

    gl.getExtension('WEBGL_lose_context'); // enable manual context loss
  }catch(e){GM.gpuInfo={supported:false};}
})();

// ─── 202. WebGL Context Pool ───
// Reuse contexts instead of creating new ones (prevents "too many contexts" crash)
GM.acquireContext=function(canvas,opts){
  if(GM.activeContexts>=GM.maxContexts){
    // Over limit - try to recycle oldest context
    var oldest=GM.contexts.shift();
    if(oldest&&oldest.canvas){
      var ext=oldest.gl.getExtension('WEBGL_lose_context');
      if(ext)ext.loseContext();
      GM.activeContexts--;
    }
  }
  opts=opts||{};
  var gl=canvas.getContext('webgl2',opts)||canvas.getContext('webgl',opts);
  if(gl){
    GM.contexts.push({gl:gl,canvas:canvas,created:Date.now()});
    GM.activeContexts++;
  }
  return gl;
};

GM.releaseContext=function(canvas){
  GM.contexts=GM.contexts.filter(function(ctx){
    if(ctx.canvas===canvas){
      try{
        var ext=ctx.gl.getExtension('WEBGL_lose_context');
        if(ext)ext.loseContext();
      }catch(e){}
      GM.activeContexts--;
      return false;
    }
    return true;
  });
};

// ─── 203. Context Lost Recovery ───
w.addEventListener('bullmoney-webgl-context-lost',function(){
  // When a context is lost, try to restore it after a delay
  setTimeout(function(){
    GM.contexts.forEach(function(ctx){
      if(ctx.gl.isContextLost()){
        var ext=ctx.gl.getExtension('WEBGL_lose_context');
        if(ext){
          try{ext.restoreContext();}catch(e){}
        }
      }
    });
  },1000);
});

// ─── 204. Canvas Resolution Manager ───
// Dynamically adjust canvas resolution based on GPU pressure
GM.optimizeCanvas=function(canvas,targetWidth,targetHeight){
  var ST=w.__BM_SPLINE_TURBO__||{};
  var scale=ST.getCanvasScale?ST.getCanvasScale():1;
  canvas.width=Math.round(targetWidth*scale);
  canvas.height=Math.round(targetHeight*scale);
  canvas.style.width=targetWidth+'px';
  canvas.style.height=targetHeight+'px';
  return scale;
};

// ─── 205-208. WebGL Memory Pressure Detection ───
// Monitor for WebGL errors that indicate GPU memory pressure
var lastGLError=0;
var glErrorCount=0;
var origGetError=null;

if(GM.gpuInfo.supported){
  // Periodic health check
  setInterval(function(){
    GM.contexts.forEach(function(ctx){
      if(!ctx.gl.isContextLost()){
        var err=ctx.gl.getError();
        if(err!==0&&err!==ctx.gl.NO_ERROR){
          glErrorCount++;
          if(glErrorCount>5){
            // GPU under pressure - reduce quality
            d.documentElement.setAttribute('data-gpu-pressure','high');
            w.dispatchEvent(new CustomEvent('bullmoney-gpu-pressure',{detail:{errors:glErrorCount}}));
          }
        }
      }
    });
  },10000);
}

// ─── 209-210. CSS containment for GPU layer management ───
var gpuStyle=d.createElement('style');
gpuStyle.textContent=[
  // Prevent GPU layer explosion
  'canvas{contain:strict;}',
  // Limit compositing layers on low-end GPUs
  '[data-gpu-pressure="high"] *{will-change:auto!important;transform:none!important;}',
  '[data-gpu-pressure="high"] canvas{image-rendering:pixelated;}',
  // Force hardware acceleration only where needed
  '.gpu-accelerated{transform:translateZ(0);will-change:transform;}',
  // Prevent stacking context explosion
  '.z-auto{z-index:auto!important;}',
].join('\n');
d.head.appendChild(gpuStyle);

d.documentElement.setAttribute('data-webgl',GM.gpuInfo.supported?'true':'false');
d.documentElement.setAttribute('data-gpu-tier',GM.gpuInfo.isIntegrated?'integrated':GM.gpuInfo.isNvidia||GM.gpuInfo.isAMD?'discrete':'unknown');
d.documentElement.setAttribute('data-max-webgl-contexts',GM.maxContexts);

if(w.location.hostname==='localhost'){
  console.log('%c[GPU MANAGER] '+(GM.gpuInfo.renderer||'Unknown GPU')+' | Max contexts: '+GM.maxContexts+' | WebGL'+(GM.gpuInfo.webgl2?'2':'1'),'color:#a855f7;font-weight:bold');
}
})();