// BULLMONEY MEMORY GUARDIAN v3.0 (auto-generated by boost.py)
// Prevents crashes on low-memory devices, in-app browsers, and heavy pages
(function(){
'use strict';
var w=window,d=document,n=navigator,p=performance;
var MG=w.__BM_MEMORY_GUARDIAN__={active:true,level:'normal',disposals:0,gcTriggers:0};

// ─── 131. Memory Pressure Detection ───
var memInfo={limit:0,used:0,pct:0};
function updateMemInfo(){
  if(p.memory){
    memInfo.used=p.memory.usedJSHeapSize;
    memInfo.limit=p.memory.jsHeapSizeLimit;
    memInfo.pct=Math.round((memInfo.used/memInfo.limit)*100);
    MG.heap={usedMB:Math.round(memInfo.used/1048576),limitMB:Math.round(memInfo.limit/1048576),pct:memInfo.pct};
  }
}

// ─── 132. Device Memory Budget Calculator ───
var deviceMem=n.deviceMemory||4;
var budgetMB=(function(){
  if(deviceMem>=8)return 350;
  if(deviceMem>=6)return 250;
  if(deviceMem>=4)return 180;
  if(deviceMem>=2)return 100;
  return 60; // <=1GB device
})();
MG.budgetMB=budgetMB;

// ─── 133. Memory Level System ───
// normal → warning → critical → emergency
function updateMemoryLevel(){
  updateMemInfo();
  var pct=memInfo.pct;
  var used=memInfo.used/1048576;
  var prev=MG.level;

  if(pct>90||used>budgetMB*1.2){MG.level='emergency';}
  else if(pct>75||used>budgetMB){MG.level='critical';}
  else if(pct>60||used>budgetMB*0.8){MG.level='warning';}
  else{MG.level='normal';}

  if(MG.level!==prev){
    d.documentElement.setAttribute('data-memory-level',MG.level);
    w.dispatchEvent(new CustomEvent('bullmoney-memory-level',{detail:{level:MG.level,pct:pct,usedMB:Math.round(used),budgetMB:budgetMB}}));

    if(MG.level==='critical'||MG.level==='emergency'){
      executeMemoryRelief(MG.level);
    }
  }
}

// ─── 134. Automatic Memory Relief Actions ───
function executeMemoryRelief(level){
  MG.gcTriggers++;

  // Level 1: Dispose off-screen images and iframes
  if(level==='critical'||level==='emergency'){
    d.querySelectorAll('img[loading="lazy"]:not([data-in-view])').forEach(function(img){
      if(!isElementInView(img)){img.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';MG.disposals++;}
    });
    // Kill off-screen iframes (YouTube embeds, etc.)
    d.querySelectorAll('iframe:not([data-keep])').forEach(function(iframe){
      if(!isElementInView(iframe)){
        iframe.setAttribute('data-src-backup',iframe.src);
        iframe.src='about:blank';
        MG.disposals++;
      }
    });
  }

  // Level 2: Reduce 3D quality but keep scenes visible (never hide)
  if(level==='emergency'){
    w.dispatchEvent(new CustomEvent('bullmoney-3d-quality-change',{detail:{quality:'low',fps:0}}));
    d.documentElement.classList.add('memory-emergency');
    // Reduce animations to near-zero but DON'T set to 0s (keeps content painted)
    d.documentElement.style.setProperty('--animation-duration','0.01s');
    d.documentElement.style.setProperty('--transition-speed','0.01s');
    d.documentElement.style.setProperty('--blur-amount','0px');
    // Lower 3D quality but keep visible
    if(w.__BM_SPLINE_TURBO__){
      w.__BM_SPLINE_TURBO__.quality='low';
      d.documentElement.setAttribute('data-3d-quality','low');
    }
    // Force garbage collection hint (Chrome)
    try{if(w.gc)w.gc();}catch(e){}
    // Pause autoplay videos to free memory (user can tap to play)
    d.querySelectorAll('video[autoplay]').forEach(function(v){
      v.pause();v.preload='none';
      v.setAttribute('data-low-mem-paused','1');
    });
  }

  if(w.location.hostname==='localhost'){
    console.warn('[MEMORY GUARDIAN] '+level+' relief executed. Disposed: '+MG.disposals+' elements');
  }
}

function isElementInView(el){
  var r=el.getBoundingClientRect();
  return r.bottom>-200&&r.top<(w.innerHeight+200);
}

// ─── 135. Periodic Memory Monitoring ───
// More aggressive on low-memory devices
var checkInterval=deviceMem>=8?10000:deviceMem>=4?5000:2000;
setInterval(updateMemoryLevel,checkInterval);
updateMemoryLevel(); // Initial check

// ─── 136. DOM Node Counter (detect leaks) ───
var lastNodeCount=0;
var nodeGrowthWarnings=0;
setInterval(function(){
  var count=d.querySelectorAll('*').length;
  if(count>lastNodeCount+500&&lastNodeCount>0){
    nodeGrowthWarnings++;
    if(nodeGrowthWarnings>=3){
      w.dispatchEvent(new CustomEvent('bullmoney-dom-leak',{detail:{nodes:count,growth:count-lastNodeCount}}));
      if(w.location.hostname==='localhost'){
        console.warn('[MEMORY GUARDIAN] Possible DOM leak: '+count+' nodes (+'+( count-lastNodeCount)+')');
      }
    }
  } else {nodeGrowthWarnings=Math.max(0,nodeGrowthWarnings-1);}
  lastNodeCount=count;
  MG.domNodes=count;
},15000);

// ─── 137. Event Listener Leak Prevention ───
// Track addEventListener calls globally to detect leaks
var listenerCount=0;
var origAdd=EventTarget.prototype.addEventListener;
var origRemove=EventTarget.prototype.removeEventListener;
EventTarget.prototype.addEventListener=function(){
  listenerCount++;MG.eventListeners=listenerCount;
  return origAdd.apply(this,arguments);
};
EventTarget.prototype.removeEventListener=function(){
  listenerCount=Math.max(0,listenerCount-1);MG.eventListeners=listenerCount;
  return origRemove.apply(this,arguments);
};

// ─── 138. Blob/ObjectURL Leak Prevention ───
var activeBlobs=new Set();
var origCreateURL=URL.createObjectURL;
var origRevokeURL=URL.revokeObjectURL;
URL.createObjectURL=function(blob){
  var url=origCreateURL.call(URL,blob);
  activeBlobs.add(url);MG.activeBlobs=activeBlobs.size;
  return url;
};
URL.revokeObjectURL=function(url){
  activeBlobs.delete(url);MG.activeBlobs=activeBlobs.size;
  return origRevokeURL.call(URL,url);
};
// Auto-revoke leaked blobs every 60s
setInterval(function(){
  if(activeBlobs.size>50){
    // Too many blobs - likely a leak, revoke oldest
    var count=0;
    activeBlobs.forEach(function(url){
      if(count++<activeBlobs.size-20){
        try{origRevokeURL.call(URL,url);}catch(e){}
        activeBlobs.delete(url);
      }
    });
    MG.activeBlobs=activeBlobs.size;
  }
},60000);

// ─── 139. Scroll Performance Budget ───
// Detect janky scrolling and reduce effects
var scrollJankCount=0;
var lastScrollTime=0;
w.addEventListener('scroll',function(){
  var now=p.now();
  if(lastScrollTime&&now-lastScrollTime>50){scrollJankCount++;}
  else{scrollJankCount=Math.max(0,scrollJankCount-1);}
  lastScrollTime=now;
  if(scrollJankCount>10){
    d.documentElement.classList.add('scroll-janky');
    scrollJankCount=0;
  }
},{passive:true});

// ─── 140. Component Disposal Queue ───
// React components can register themselves for disposal during memory pressure
MG.disposalQueue=[];
MG.registerForDisposal=function(id,disposeFn,priority){
  MG.disposalQueue.push({id:id,dispose:disposeFn,priority:priority||5});
  MG.disposalQueue.sort(function(a,b){return b.priority-a.priority;}); // highest priority disposed first
};
MG.executeDisposalQueue=function(count){
  count=count||3;
  var disposed=MG.disposalQueue.splice(0,count);
  disposed.forEach(function(item){
    try{item.dispose();MG.disposals++;}catch(e){}
  });
  return disposed.length;
};
// Auto-dispose on memory pressure
w.addEventListener('bullmoney-memory-level',function(e){
  if(e.detail.level==='critical')MG.executeDisposalQueue(3);
  if(e.detail.level==='emergency')MG.executeDisposalQueue(10);
});

// ─── 141-145. Memory-Aware CSS Injection (FULL EXPERIENCE - never hide content) ───
var memStyle=d.createElement('style');
memStyle.textContent=[
  // Warning level - reduce blur/shadows but keep everything visible
  '[data-memory-level="warning"] *{backdrop-filter:none!important;-webkit-backdrop-filter:none!important;}',
  '[data-memory-level="warning"] .glass-effect,.glassmorphism{backdrop-filter:none!important;background:rgba(0,0,0,0.8)!important;}',
  // Critical level - fastest possible animations (but keep content visible)
  // Exempt product card shimmer (transform-only, cheap) from speed override
  '[data-memory-level="critical"] *:not(.product-card-premium):not(.badge-shimmer-el):not(.card-shine-sweep):not(.card-image-shine):not(.neon-edge-top):not(.neon-edge-bottom){animation-duration:0.01s!important;transition-duration:0.01s!important;}',
  '[data-memory-level="critical"] .particle-container,.confetti{opacity:0.3!important;animation:none!important;}',
  // Emergency - strip decorative effects only (keep ALL content: videos, canvas, images, gifs, iframes)
  // Product card neon/shimmer is exempt — they use transforms not layout
  '[data-memory-level="emergency"] *:not(.product-card-premium):not(.badge-shimmer-el):not(.card-shine-sweep):not(.card-image-shine):not(.neon-edge-top):not(.neon-edge-bottom){animation:none!important;transition:none!important;box-shadow:none!important;filter:none!important;backdrop-filter:none!important;-webkit-backdrop-filter:none!important;}',
  // CRITICAL: Never hide videos, iframes, images, or canvas - only reduce cost
  '[data-memory-level="emergency"] video{animation:none!important;}',
  '[data-memory-level="emergency"] canvas{image-rendering:optimizeSpeed!important;}',
  '[data-memory-level="emergency"] img{image-rendering:auto!important;}',
  // Low-memory full experience: everything visible, lightweight rendering
  '.low-memory-adapt *{backdrop-filter:none!important;-webkit-backdrop-filter:none!important;}',
  '.low-memory-adapt .glass-effect,.low-memory-adapt .glassmorphism{background:rgba(0,0,0,0.85)!important;}',
  '.low-memory-adapt video{object-fit:cover;}',
  // Mobile full experience: show all desktop content on narrow viewports
  '.mobile-full-experience [data-desktop-only]{display:block!important;visibility:visible!important;}',
  '.mobile-full-experience [data-hide-mobile]{display:block!important;visibility:visible!important;}',
  '.mobile-full-experience .desktop-only{display:block!important;visibility:visible!important;}',
  '.mobile-full-experience .hidden-mobile{display:block!important;visibility:visible!important;}',
  // Scroll jank fix
  '.scroll-janky *{will-change:auto!important;contain:layout style;}',
].join('\n');
d.head.appendChild(memStyle);

// ─── 146-150. Performance.measureUserAgentSpecificMemory (modern API) ───
if(typeof crossOriginIsolated!=='undefined'&&crossOriginIsolated&&p.measureUserAgentSpecificMemory){
  setInterval(function(){
    p.measureUserAgentSpecificMemory().then(function(result){
      MG.preciseMemoryMB=Math.round(result.bytes/1048576);
      if(MG.preciseMemoryMB>budgetMB){
        updateMemoryLevel();
      }
    }).catch(function(){});
  },30000);
}

// ─── 151-155. Page Lifecycle API Integration ───
// Freeze/resume with browser lifecycle (mobile Chrome backgrounding)
if('onfreeze' in d){
  d.addEventListener('freeze',function(){
    MG.frozen=true;
    w.dispatchEvent(new CustomEvent('bullmoney-3d-pause'));
    w.dispatchEvent(new CustomEvent('bullmoney-spline-dispose'));
  });
  d.addEventListener('resume',function(){
    MG.frozen=false;
    if(MG.level==='normal'||MG.level==='warning'){
      w.dispatchEvent(new CustomEvent('bullmoney-3d-resume'));
    }
  });
}

d.documentElement.setAttribute('data-memory-level',MG.level);
d.documentElement.setAttribute('data-memory-budget',budgetMB);

if(w.location.hostname==='localhost'){
  console.log('%c[MEMORY GUARDIAN] Active | Budget: '+budgetMB+'MB | Device: '+deviceMem+'GB | Check every '+checkInterval+'ms','color:#22c55e;font-weight:bold');
}
})();