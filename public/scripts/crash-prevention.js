// BULLMONEY CRASH PREVENTION v3.0 (auto-generated by boost.py)
// Specifically targets Store page and App page crash scenarios
(function(){
'use strict';
var w=window,d=document,p=performance;
var CP=w.__BM_CRASH_PREVENT__={active:true,renderedSections:0,maxSections:20,frozenSections:[]};

// ─── 171. Page-Specific Detection ───
var path=w.location.pathname;
var isStorePage=path==='/store'||path.startsWith('/store/');
var isAppPage=path==='/'||path==='/app';
var isHeavyPage=isStorePage||isAppPage;

if(!isHeavyPage){CP.active=false;return;}

d.documentElement.setAttribute('data-heavy-page',isStorePage?'store':'app');

// ─── 172. Incremental Section Renderer ───
// Don't render all sections at once - drip-feed them as user scrolls
var sectionQueue=[];
var renderingPaused=false;

CP.queueSection=function(sectionId,renderFn){
  sectionQueue.push({id:sectionId,render:renderFn,rendered:false});
};
CP.renderNextSection=function(){
  if(renderingPaused)return false;
  var next=sectionQueue.find(function(s){return !s.rendered;});
  if(next){
    next.rendered=true;
    CP.renderedSections++;
    try{next.render();}catch(e){
      if(w.location.hostname==='localhost')console.error('[CRASH PREVENT] Section render failed:',next.id,e);
    }
    return true;
  }
  return false;
};

// Render sections progressively via requestIdleCallback
function drainQueue(){
  if(CP.renderNextSection()){
    if('requestIdleCallback' in w){
      requestIdleCallback(drainQueue,{timeout:500});
    } else {
      setTimeout(drainQueue,100);
    }
  }
}

// ─── 173. Scroll-Triggered Section Rendering ───
var scrollRenderIO=null;
if('IntersectionObserver' in w){
  scrollRenderIO=new IntersectionObserver(function(entries){
    entries.forEach(function(entry){
      if(entry.isIntersecting){
        var el=entry.target;
        var sectionId=el.getAttribute('data-section-id');
        if(sectionId){
          el.classList.remove('section-frozen');
          el.classList.add('section-active');
          el.dispatchEvent(new CustomEvent('section-activate'));
          // Restore iframes that were blanked
          el.querySelectorAll('iframe[data-src-backup]').forEach(function(iframe){
            iframe.src=iframe.getAttribute('data-src-backup');
            iframe.removeAttribute('data-src-backup');
          });
        }
      } else {
        // Off-screen: freeze section to save memory
        var el2=entry.target;
        var sid=el2.getAttribute('data-section-id');
        if(sid&&CP.renderedSections>5){
          // Only freeze if we have many sections rendered
          el2.classList.add('section-frozen');
          el2.classList.remove('section-active');
          el2.dispatchEvent(new CustomEvent('section-freeze'));
          CP.frozenSections.push(sid);
        }
      }
    });
  },{rootMargin:'300px 0px 300px 0px',threshold:[0]});
}

CP.observeSection=function(el){
  if(scrollRenderIO)scrollRenderIO.observe(el);
};

// ─── 174. Product Grid Virtualization Hints ───
// For store page: only render visible product cards
if(isStorePage){
  var gridStyle=d.createElement('style');
  gridStyle.textContent=[
    // Content-visibility for product cards: browser can skip rendering off-screen items
    // Use contain:layout style (NOT paint) so shimmer animations render properly
    '.product-card,.store-product-item,[data-product-id]{content-visibility:auto;contain-intrinsic-size:auto 300px;}',
    // Contain product images to prevent layout thrash
    '.product-card img,.store-product-item img{contain:layout style;content-visibility:auto;contain-intrinsic-size:auto 250px;}',
    // Infinite scroll sentinel
    '.products-sentinel{height:1px;width:100%;}',
    // Frozen sections save GPU layers (keep canvas/video/gifs visible)
    // EXEMPT product card shimmer elements from freeze — they are lightweight CSS-only
    '.section-frozen iframe:not([data-keep]){visibility:hidden!important;}',
    '.section-frozen *:not(canvas):not(video):not(.badge-shimmer-el):not(.card-shine-sweep):not(.card-image-shine):not(.neon-edge-top):not(.neon-edge-bottom):not(.product-card-premium){animation-play-state:paused!important;}',
    // Active sections get GPU boost
    '.section-active{will-change:auto;}',
    // Product card animations are transform-based (cheap) — protect from memory-level kills
    '[data-memory-level] .product-card-premium,[data-memory-level] .badge-shimmer-el,[data-memory-level] .card-shine-sweep,[data-memory-level] .card-image-shine{animation-duration:revert!important;transition-duration:revert!important;}',
    // Mobile mosaic grid compatibility
    '[class*="mobile-mosaic-"] .product-card-premium{contain:layout style!important;}',
  ].join('\n');
  d.head.appendChild(gridStyle);
}

// ─── 175. Heavy Component Budget ───
// Track how many heavy components are mounted simultaneously
var heavyComponents=new Map();
var maxHeavyComponents=(function(){
  var mem=(navigator.deviceMemory||4);
  if(mem>=8)return 8;
  if(mem>=4)return 5;
  if(mem>=2)return 3;
  return 2;
})();
CP.maxHeavyComponents=maxHeavyComponents;

CP.registerHeavy=function(id,weight){
  heavyComponents.set(id,{weight:weight||1,mounted:Date.now()});
  // Check if over budget
  var totalWeight=0;
  heavyComponents.forEach(function(c){totalWeight+=c.weight;});
  if(totalWeight>maxHeavyComponents){
    // Dispose oldest heavy component
    var oldest=null,oldestTime=Infinity;
    heavyComponents.forEach(function(c,key){
      if(c.mounted<oldestTime){oldestTime=c.mounted;oldest=key;}
    });
    if(oldest){
      w.dispatchEvent(new CustomEvent('bullmoney-dispose-component',{detail:{id:oldest}}));
      heavyComponents.delete(oldest);
    }
  }
  return totalWeight<=maxHeavyComponents;
};
CP.unregisterHeavy=function(id){heavyComponents.delete(id);};

// ─── 176-180. Smart Image Loading for Store ───
if(isStorePage&&'IntersectionObserver' in w){
  var imgIO=new IntersectionObserver(function(entries){
    entries.forEach(function(entry){
      var img=entry.target;
      if(entry.isIntersecting){
        img.setAttribute('data-in-view','1');
        if(img.dataset.lazySrc){
          img.src=img.dataset.lazySrc;
          delete img.dataset.lazySrc;
        }
      } else {
        img.removeAttribute('data-in-view');
      }
    });
  },{rootMargin:'400px 0px 400px 0px'});

  // Observe product images
  function observeProductImages(){
    d.querySelectorAll('.product-card img,.store-product-item img').forEach(function(img){
      imgIO.observe(img);
    });
  }
  if(d.readyState==='loading')d.addEventListener('DOMContentLoaded',observeProductImages);
  else observeProductImages();
  // Re-observe on new products loaded
  new MutationObserver(function(muts){
    muts.forEach(function(m){
      m.addedNodes.forEach(function(node){
        if(node.nodeType===1){
          var imgs=node.querySelectorAll?node.querySelectorAll('.product-card img,.store-product-item img'):[];
          imgs.forEach(function(img){imgIO.observe(img);});
        }
      });
    });
  }).observe(d.body||d.documentElement,{childList:true,subtree:true});
}

// ─── 181-185. Hero Carousel Memory Management ───
// Only keep 2 slides in DOM at a time (current + next)
CP.heroSlideLimit=3; // max DOM slides
CP.activeSlideIndex=0;

// ─── 186. Global Content-Visibility Optimization ───
var cvStyle=d.createElement('style');
cvStyle.textContent=[
  // Non-hero sections get content-visibility:auto (NEVER hero - it blocks scroll)
  'section:not(#hero):not(.hero):not([data-hero]),[data-section-id],.page-section{content-visibility:auto;contain-intrinsic-size:auto 500px;}',
  // Hero MUST always be visible + scrollable
  '#hero,.hero-section,.hero,[data-hero]{content-visibility:visible!important;overflow:visible!important;}',
  // Hero internals must never block scroll
  '#hero .hero-wrapper,.hero .hero-wrapper{overflow:visible!important;overflow-x:hidden!important;touch-action:pan-y!important;}',
  '#hero canvas,#hero .cycling-bg-layer,#hero .cycling-bg-item,#hero .cycling-bg-item.active,#hero [data-spline],#hero spline-viewer{pointer-events:none!important;touch-action:pan-y!important;}',
  // Footer can be fully deferred
  'footer,.footer-section{content-visibility:auto;contain-intrinsic-size:auto 400px;}',
  // Store-specific: product grid sections
  '.products-grid-section{content-visibility:auto;contain-intrinsic-size:auto 800px;}',
  // Modals are hidden until opened (save rendering cost)
  '.modal-overlay:not(.modal-open){content-visibility:hidden;}',
  // Heavy components use containment but not strict (strict blocks scroll)
  '.world-map-container,.chart-container,.testimonials-section{contain:layout style paint;content-visibility:auto;contain-intrinsic-size:auto 400px;}',
  // SCROLL SAFETY: ensure html/body always scrollable
  'html,body{overflow-y:auto!important;height:auto!important;touch-action:pan-y pan-x!important;}',
].join('\n');
d.head.appendChild(cvStyle);

// ─── 187-190. Error Boundary Integration ───
// Catch React render errors and fall back gracefully
var renderErrors=0;
w.addEventListener('error',function(e){
  var msg=(e.message||'').toLowerCase();
  // Detect common crash-causing errors
  if(msg.indexOf('out of memory')>-1||msg.indexOf('aw, snap')>-1||msg.indexOf('allocation failed')>-1||msg.indexOf('maximum call stack')>-1){
    renderErrors++;
    if(renderErrors>=2){
      // Emergency mode - strip the page down
      d.documentElement.classList.add('emergency-mode','reduce-effects','memory-emergency');
      w.dispatchEvent(new CustomEvent('bullmoney-emergency-mode'));
      // Kill all canvases and iframes
      d.querySelectorAll('canvas:not([data-keep]),iframe:not([data-keep])').forEach(function(el){
        el.remove();
      });
      // Show recovery message
      var overlay=d.createElement('div');
      overlay.style.cssText='position:fixed;top:16px;left:50%;transform:translateX(-50%);padding:12px 24px;background:#1a1a2e;border:1px solid #ffd700;border-radius:12px;color:#ffd700;font-family:system-ui;font-size:14px;z-index:999999;text-align:center;';
      overlay.innerHTML='\u26a1 Performance mode activated for smoother experience';
      d.body.appendChild(overlay);
      setTimeout(function(){overlay.remove();},5000);
    }
  }
});

if(w.location.hostname==='localhost'){
  console.log('%c[CRASH PREVENT] Active on '+(isStorePage?'Store':'App')+' page | Max heavy: '+maxHeavyComponents+' | Sections queued: '+sectionQueue.length,'color:#ef4444;font-weight:bold');
}
})();