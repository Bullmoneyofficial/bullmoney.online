/* BULLMONEY BRAIN v3.0 — Combined runtime: network + inapp + memory + spline + offline
   Single file replaces 5 separate scripts for 1 HTTP request, faster init, shared closures */
(function(){
'use strict';
var w=window,d=document,n=navigator,p=performance;
var ua=n.userAgent||'';
var B=w.__BM_BRAIN__=w.__BM_BRAIN__||{};
var docEl=d.documentElement;
var conn=n.connection||n.mozConnection||n.webkitConnection||{};
var mem=n.deviceMemory||4;
var cores=n.hardwareConcurrency||4;
var dpr=w.devicePixelRatio||1;
var isMobile=/mobi|android|iphone|ipad|ipod/i.test(ua);
var isIOS=/iphone|ipad|ipod/i.test(ua)||(/macintosh/i.test(ua)&&n.maxTouchPoints>1);
var isAndroid=/android/i.test(ua);
var isDev=w.location&&w.location.hostname==='localhost';

// Shared helpers — used by all modules (no duplication)
function onReady(fn){if(d.readyState==='loading')d.addEventListener('DOMContentLoaded',fn,{once:true});else fn();}
function onIdle(fn,t){if('requestIdleCallback' in w)return w.requestIdleCallback(fn,{timeout:t||1200});return setTimeout(fn,t||1200);}
function emit(name,detail){try{w.dispatchEvent(new CustomEvent(name,{detail:detail}));}catch(e){}}
function setAttr(k,v){if(docEl)docEl.setAttribute(k,v);}

// ═══════════════════════════════════════════════════════════════
// 1. IN-APP SHIELD — detect in-app browsers, apply fixes
// ═══════════════════════════════════════════════════════════════
var S=w.__BM_INAPP_SHIELD__={active:false,browser:null,fixes:[]};
var isInApp=false;
var dets=[
  ['instagram',/instagram/i],['tiktok',/tiktok|bytedance|musical_ly/i],
  ['facebook',/fban|fbav|fb_iab|facebook/i],['twitter',/twitter/i],
  ['snapchat',/snapchat/i],['linkedin',/linkedin/i],['wechat',/micromessenger|wechat/i],
  ['line',/line\//i],['telegram',/telegram/i],['pinterest',/pinterest/i],
  ['reddit',/reddit/i],['discord',/discord/i],
  ['webview-ios',/\bwv\b.*safari/i],['webview-android',/\bwv\b/i]
];
for(var i=0;i<dets.length;i++){
  if(dets[i][1].test(ua)){S.browser=dets[i][0];S.active=true;isInApp=true;break;}
}
if(isInApp){
  B.inApp={active:true,browser:S.browser};
  emit('bm:inapp',B.inApp);
  docEl.setAttribute('data-inapp',S.browser);
  docEl.classList.add('in-app-browser','reduce-effects');
  // Viewport fix
  var fixVP=function(){
    var h=(w.visualViewport&&w.visualViewport.height)||w.innerHeight;
    var ww=(w.visualViewport&&w.visualViewport.width)||w.innerWidth;
    var rs=docEl.style;
    rs.setProperty('--vh',(h*0.01)+'px');
    rs.setProperty('--app-height',h+'px');
    rs.setProperty('--app-width',ww+'px');
    if(!rs.getPropertyValue('--safe-bottom'))rs.setProperty('--safe-bottom','env(safe-area-inset-bottom,0px)');
  };
  fixVP();
  w.addEventListener('resize',fixVP,{passive:true});
  if(w.visualViewport)w.visualViewport.addEventListener('resize',fixVP,{passive:true});
  // Scroll fix
  var scrollFix=function(){
    if(!d.body)return;
    var isGames=docEl.hasAttribute('data-games-page')||d.body.hasAttribute('data-games-page')||w.location.pathname.indexOf('/games')===0;
    if(isGames){d.body.style.overscrollBehavior='auto';docEl.style.overscrollBehavior='auto';d.body.style.touchAction='auto';return;}
    d.body.style.overscrollBehavior='none';docEl.style.overscrollBehavior='none';d.body.style.touchAction='pan-x pan-y';
  };
  onReady(scrollFix);setTimeout(scrollFix,600);
  // CSS
  var sty=d.createElement('style');
  sty.textContent='.in-app-browser *{animation-duration:.16s!important;transition-duration:.12s!important}.in-app-browser .particle-container,.in-app-browser .confetti{opacity:0!important;pointer-events:none!important;height:0!important;overflow:hidden!important}.in-app-browser .aurora{opacity:.05!important}.in-app-browser .glass-effect,.in-app-browser .glassmorphism,.in-app-browser .glass-surface,.in-app-browser .glass-card{backdrop-filter:none!important;-webkit-backdrop-filter:none!important;background:rgba(5,9,21,.86)!important;border-color:rgba(255,255,255,.06)!important}.in-app-browser .circular-gallery,.in-app-browser .card-swap{animation:none!important}.in-app-browser .color-bends{animation:none!important;opacity:.55!important}';
  if(d.head)d.head.appendChild(sty);
  // External link handler
  d.addEventListener('click',function(e){
    var a=e.target&&e.target.closest?e.target.closest('a[href]'):null;
    if(!a)return;var href=a.getAttribute('href')||'';
    if(href.indexOf('http')!==0||href.indexOf(w.location.hostname)!==-1)return;
    if(S.browser==='instagram'||S.browser==='tiktok'){e.preventDefault();w.open(href,'_system')||w.open(href,'_blank');}
  },true);
  // Crash recovery
  var crashKey='bm_inapp_crashes';
  var crashes=parseInt(sessionStorage.getItem(crashKey)||'0',10);
  if(crashes>0){
    docEl.classList.add('ultra-light-mode');
    var ultra=d.createElement('style');
    ultra.textContent='.ultra-light-mode *{animation:none!important;transition:none!important;backdrop-filter:none!important;-webkit-backdrop-filter:none!important}.ultra-light-mode *:not(.product-card-premium):not(input):not(button):not(a){box-shadow:none!important}.ultra-light-mode .glass-effect,.ultra-light-mode .glassmorphism,.ultra-light-mode .glass-surface,.ultra-light-mode .glass-card{background:rgba(5,9,21,.9)!important;border-color:rgba(255,255,255,.05)!important}';
    if(d.head)d.head.appendChild(ultra);
  }
  sessionStorage.setItem(crashKey,String(crashes+1));
  w.addEventListener('load',function(){setTimeout(function(){sessionStorage.setItem(crashKey,'0');},2500);},{once:true});
  // Open-in-browser banner
  if(S.browser==='instagram'||S.browser==='tiktok'||S.browser==='facebook'){
    w.addEventListener('load',function(){
      setTimeout(function(){
        if(d.getElementById('bm-open-browser')||!d.body)return;
        var bar=d.createElement('div');bar.id='bm-open-browser';
        bar.style.cssText='position:fixed;bottom:0;left:0;right:0;padding:10px 16px;background:linear-gradient(135deg,#1a1a2e,#0a0a0a);border-top:1px solid rgba(255,215,0,.3);z-index:99999;display:flex;align-items:center;justify-content:space-between;gap:8px;font-family:system-ui,-apple-system,sans-serif';
        bar.innerHTML='<span style="color:#ffd700;font-size:13px">\u26A1 Open in browser for best performance</span><div style="display:flex;gap:6px"><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid rgba(255,255,255,.2);color:#999;padding:4px 10px;border-radius:6px;font-size:12px;cursor:pointer">Dismiss</button><a href="'+w.location.href+'" target="_blank" style="background:linear-gradient(135deg,#ffd700,#f59e0b);color:#000;padding:4px 12px;border-radius:6px;font-size:12px;text-decoration:none;font-weight:600">Open</a></div>';
        d.body.appendChild(bar);
      },1800);
    },{once:true});
  }
  if(isDev)console.log('[INAPP] browser=',S.browser);
}

// ═══════════════════════════════════════════════════════════════
// 2. NETWORK OPTIMIZER — strategy, prefetch, fetch wrapper
// ═══════════════════════════════════════════════════════════════
var NW=w.__BM_NETWORK__=w.__BM_NETWORK__||{prefetched:new Set(),priorities:{}};

function computeStrategy(){
  var type=conn.effectiveType||'4g';
  var saveData=!!conn.saveData;
  var downlink=conn.downlink||10;
  var strategy='normal';
  if(saveData||type==='2g'||type==='slow-2g')strategy='minimal';
  else if(type==='3g'||downlink<1.5||mem<=2)strategy='conservative';
  else if(type==='4g'&&downlink>=5&&mem>=6)strategy='aggressive';
  if(isInApp&&strategy==='aggressive')strategy='normal';
  if(B.memory&&B.memory.level==='critical')strategy='minimal';
  NW.strategy=strategy;NW.effectiveType=type;NW.downlinkMbps=downlink;NW.saveData=saveData;
  B.network={strategy:strategy,type:type,downlink:downlink,saveData:saveData};
  setAttr('data-network-strategy',strategy);
  if(docEl)docEl.style.setProperty('--img-quality',String(NW.getImageQuality()));
  emit('bm:network-strategy',B.network);
}
NW.getImageQuality=function(){return NW.strategy==='minimal'?45:NW.strategy==='conservative'?62:NW.strategy==='aggressive'?88:75;};
NW._doLoad=function(url,type,pri){
  if(!url||d.querySelector('link[href="'+url+'"]'))return Promise.resolve(url||null);
  var lnk=d.createElement('link');
  if(type==='style'){lnk.rel='preload';lnk.as='style';}
  else if(type==='script'){lnk.rel='preload';lnk.as='script';}
  else if(type==='image'){lnk.rel='preload';lnk.as='image';}
  else if(type==='font'){lnk.rel='preload';lnk.as='font';lnk.crossOrigin='anonymous';}
  else lnk.rel='prefetch';
  if(pri)lnk.fetchPriority=pri;lnk.href=url;
  (d.head||docEl).appendChild(lnk);return Promise.resolve(url);
};
NW.loadResource=function(url,type,priority){
  priority=priority||'low';NW.priorities[url]=priority;
  if(NW.strategy==='minimal'&&priority==='low')return Promise.resolve(null);
  if(NW.strategy==='conservative'&&priority==='low')return new Promise(function(r){onIdle(function(){r(NW._doLoad(url,type));},2500);});
  return NW._doLoad(url,type,priority==='high'?'high':undefined);
};
var inflight=new Map();
NW.fetch=function(url,opts){
  opts=opts||{};var retries=typeof opts.retries==='number'?opts.retries:1;
  var timeout=typeof opts.timeout==='number'?opts.timeout:9000;
  function attempt(rem){
    var controller,timer;
    if('AbortController' in w){controller=new AbortController();timer=setTimeout(function(){controller.abort();},timeout);}
    return fetch(url,Object.assign({},opts,controller?{signal:controller.signal}:{}))
      .finally(function(){if(timer)clearTimeout(timer);})
      .catch(function(err){if(rem<=0)throw err;return new Promise(function(r){setTimeout(function(){r(attempt(rem-1));},700);});});
  }
  return attempt(retries);
};
NW.deduplicatedFetch=function(url,opts){
  var key=url+JSON.stringify(opts||{});
  if(inflight.has(key))return inflight.get(key);
  var pr=NW.fetch(url,opts).finally(function(){inflight.delete(key);});
  inflight.set(key,pr);return pr;
};
function prefetchRoutes(){
  var preds={'/':['/about','/store','/Blogs','/community'],'/about':['/community','/recruit'],'/Blogs':['/community','/'],'/store':['/products','/shop'],'/community':['/socials','/course'],'/course':['/Prop','/community']};
  if(NW.strategy==='minimal')return;
  var cur=w.location.pathname;var predicted=preds[cur]||[];
  var limit=NW.strategy==='aggressive'?3:NW.strategy==='normal'?2:1;
  predicted.slice(0,limit).forEach(function(route){
    if(NW.prefetched.has(route))return;NW.prefetched.add(route);
    var lnk=d.createElement('link');lnk.rel='prefetch';lnk.href=route;(d.head||docEl).appendChild(lnk);
  });
}
function watchHeroImages(){
  if(!('IntersectionObserver' in w))return;
  var io=new IntersectionObserver(function(entries){
    entries.forEach(function(entry){
      if(!entry.isIntersecting)return;
      var img=entry.target;if(img.getAttribute('loading')==='lazy')img.removeAttribute('loading');
      img.setAttribute('fetchpriority','high');io.unobserve(img);
    });
  },{rootMargin:'120px',threshold:0});
  onReady(function(){var imgs=d.querySelectorAll('.hero img, [data-hero] img, section:first-of-type img');for(var i=0;i<imgs.length;i++)io.observe(imgs[i]);});
}
computeStrategy();
if(conn.addEventListener)conn.addEventListener('change',computeStrategy);
w.addEventListener('bm:memory',computeStrategy);
w.addEventListener('bm:inapp',computeStrategy);
onIdle(prefetchRoutes,2200);
watchHeroImages();
if(isDev)console.log('[NETWORK] strategy=',NW.strategy);

// ═══════════════════════════════════════════════════════════════
// 3. MOBILE CRASH SHIELD — memory management, cleanup, defer
// ═══════════════════════════════════════════════════════════════
function memoryBudget(){
  if(isIOS)return isInApp?50:(mem>=4?110:75);
  if(isAndroid)return isInApp?85:(mem>=8?300:mem>=6?230:mem>=4?170:110);
  if(isMobile)return mem>=6?220:mem>=4?160:95;
  return 500;
}
var Shield=w.__BM_CRASH_SHIELD__={
  active:true,memoryBudget:memoryBudget(),currentMemoryMB:0,cleanupCount:0,
  isMobile:isMobile,isInApp:isInApp,deviceMem:mem,deferredComponents:0,
  queueSplineLoad:queueSplineLoad,
  shouldReduceQuality:function(){return currentLevel()!=='normal';},
  shouldSkipHeavyEffect:function(){var l=currentLevel();return l==='critical'||(isMobile&&l==='warning');}
};
function emitMem(detail){
  B.memory={level:detail.level,memoryMB:detail.memoryMB,budgetMB:Shield.memoryBudget};
  emit('bm:memory',B.memory);
  emit('bullmoney-performance-hint',{skipHeavy:Shield.shouldSkipHeavyEffect(),reduceQuality:Shield.shouldReduceQuality(),memoryMB:detail.memoryMB,budgetMB:Shield.memoryBudget});
}
function currentLevel(){
  if(!p.memory)return(isMobile&&mem<=2)?'warning':'normal';
  var used=Math.round((p.memory.usedJSHeapSize||0)/1048576);
  Shield.currentMemoryMB=used;
  var pct=(used/Math.max(Shield.memoryBudget,1))*100;
  if(pct>=88)return'critical';if(pct>=72)return'warning';return'normal';
}
var lastCleanup=0;
function cleanup(level){
  var cooldown=level==='critical'?8000:14000;
  var now=Date.now();if(now-lastCleanup<cooldown)return;lastCleanup=now;Shield.cleanupCount++;
  var images=d.querySelectorAll('img[loading="lazy"]');
  for(var i=0;i<images.length;i++){
    var img=images[i],r=img.getBoundingClientRect();
    if(r.bottom<-420||r.top>w.innerHeight+420){
      if(img.dataset&&img.dataset.lazyOriginal)continue;
      if(img.src&&img.src.indexOf('data:')!==0){img.dataset.lazyOriginal=img.src;img.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';}
    }
  }
  var canvases=d.querySelectorAll('canvas');
  for(var j=0;j<canvases.length;j++){
    var c=canvases[j],cr=c.getBoundingClientRect();
    if(c.closest('[data-spline],[data-spline-scene],[data-keep-canvas],[data-spline-hero]'))continue;
    if(cr.bottom<-420||cr.top>w.innerHeight+420){var ctx=c.getContext&&c.getContext('2d');if(ctx)ctx.clearRect(0,0,c.width,c.height);c.width=1;c.height=1;}
  }
  var vids=d.querySelectorAll('video');
  for(var k=0;k<vids.length;k++){
    var v=vids[k],vr=v.getBoundingClientRect();
    if(vr.bottom<-320||vr.top>w.innerHeight+320){if(!v.paused){v.pause();v.dataset.wasAutoPlaying='1';}}
  }
  if(level==='critical'){try{if(w.gc)w.gc();}catch(e){}}
}
function monitor(){
  var level=currentLevel();
  if(level==='critical')cleanup('critical');else if(level==='warning')cleanup('warning');
  emitMem({level:level,memoryMB:Shield.currentMemoryMB});
}
function smartCacheCleanup(){
  if(!('caches' in w)||!w.caches)return;
  caches.keys().then(function(names){
    var keep=/spline|critical|static-v|next-data/i;var del=3;
    for(var i=0;i<names.length&&del>0;i++){if(!keep.test(names[i])){del--;caches.delete(names[i]);}}
  }).catch(function(){});
}
// Spline load queue
var queue=[],active=0;
function queueSplineLoad(url,cb){if(!url){if(cb)cb();return;}queue.push({url:url,cb:cb||function(){}});pump();}
function pump(){
  var strategy=(B.network&&B.network.strategy)||'normal';
  var max=isMobile?1:(strategy==='aggressive'?3:2);
  if(active>=max||queue.length===0)return;
  var next=queue.shift();active++;
  fetch(next.url,{cache:'force-cache',priority:strategy==='aggressive'?'high':'low'})
    .catch(function(){}).finally(function(){try{next.cb();}catch(e){}active--;setTimeout(pump,100);});
}
function deferHeavyComponent(sel,loadCb,opts){
  opts=opts||{};var margin=opts.margin||'350px';
  var start=function(){
    var el=d.querySelector(sel);if(!el)return;
    if(!('IntersectionObserver' in w)){loadCb();return;}
    var io=new IntersectionObserver(function(entries){
      for(var i=0;i<entries.length;i++){if(entries[i].isIntersecting){loadCb();Shield.deferredComponents++;io.disconnect();break;}}
    },{rootMargin:margin,threshold:0.01});
    io.observe(el);
  };
  onIdle(start,1800);
}
w.deferHeavyComponent=deferHeavyComponent;
// Timers — faster on mobile, relaxed on desktop
var monInt=isMobile?4000:8000;
setInterval(monitor,monInt);setTimeout(monitor,1000);
setTimeout(smartCacheCleanup,5000);setInterval(smartCacheCleanup,10*60*1000);
d.addEventListener('visibilitychange',function(){if(d.visibilityState==='hidden')cleanup('critical');else setTimeout(monitor,600);});
w.addEventListener('pagehide',function(){cleanup('critical');},{once:true});
w.addEventListener('bm:network-strategy',pump);
w.__BM_SHOULD_SKIP_HEAVY__=Shield.shouldSkipHeavyEffect;
w.__BM_SHOULD_REDUCE_QUALITY__=Shield.shouldReduceQuality;
setAttr('data-crash-shield','active');
if(isDev)console.log('[CRASH SHIELD] budget=',Shield.memoryBudget,'mobile=',isMobile);

// ═══════════════════════════════════════════════════════════════
// 4. SPLINE UNIVERSAL — always-render quality management
// ═══════════════════════════════════════════════════════════════
var SU=w.__BM_SPLINE_UNIVERSAL__=w.__BM_SPLINE_UNIVERSAL__||{scenes:{},alwaysRender:true,loaded:false};

function computeQuality(){
  var network=(B.network&&B.network.strategy)||'normal';
  var memory=(B.memory&&B.memory.level)||'normal';
  var quality='high';
  if(network==='minimal'||memory==='critical')quality='low';
  else if(network==='conservative'||memory==='warning')quality='medium';
  else if(mem>=8&&cores>=6&&!isMobile&&!isInApp)quality='ultra';
  else if(isMobile&&mem<4)quality='medium';
  SU.quality=quality;setAttr('data-spline-quality',quality);return quality;
}
function qualityScale(){var q=SU.quality||computeQuality();return q==='ultra'?Math.min(dpr,2):q==='high'?Math.min(dpr,1.5):q==='medium'?1:0.75;}
function textureLimit(){var q=SU.quality||computeQuality();return q==='ultra'?4096:q==='high'?2048:q==='medium'?1024:512;}
function targetFPS(){var q=SU.quality||computeQuality();if(q==='ultra'&&!isMobile)return 120;if(q==='low')return 45;return 60;}

SU.getCanvasScale=qualityScale;SU.getMaxTextureSize=textureLimit;SU.getTargetFPS=targetFPS;
SU.createOptimizedWebGLContext=function(canvas,opts){
  opts=opts||{};var q=SU.quality||computeQuality();
  var s={alpha:q!=='low',antialias:q==='ultra'||q==='high',powerPreference:q==='ultra'?'high-performance':'default',preserveDrawingBuffer:false,stencil:q!=='low',depth:true,failIfMajorPerformanceCaveat:false};
  for(var k in opts)s[k]=opts[k];
  return canvas.getContext('webgl2',s)||canvas.getContext('webgl',s)||canvas.getContext('experimental-webgl',s);
};
SU.loadScene=function(container,url){
  container.classList.add('spline-loading');container.setAttribute('data-spline-quality',SU.quality||computeQuality());
  container.setAttribute('data-spline-scale',String(qualityScale()));container.setAttribute('data-spline-max-texture',String(textureLimit()));
  var meta={url:url,container:container,loadStart:p.now(),quality:SU.quality,visible:true};SU.scenes[url]=meta;
  return new Promise(function(resolve){
    var done=function(){container.removeEventListener('spline-loaded',done);container.classList.remove('spline-loading');container.classList.add('spline-loaded');meta.loadTime=Math.round(p.now()-meta.loadStart);meta.loaded=true;resolve(meta);};
    container.addEventListener('spline-loaded',done,{once:true});
  });
};
SU.cacheScene=function(url){
  if(!url||!('caches' in w)||!w.caches)return Promise.resolve(false);
  return caches.open('bullmoney-spline-v3').then(function(cache){
    return cache.match(url).then(function(hit){if(hit)return true;return fetch(url,{cache:'force-cache'}).then(function(r){if(r&&r.ok){try{cache.put(url,r.clone());}catch(e){}return true;}return false;}).catch(function(){return false;});});
  }).catch(function(){return false;});
};
SU.preloadScenes=function(urls){
  if(!Array.isArray(urls)||!urls.length)return;
  if(NW.strategy==='minimal')return;
  onIdle(function(){for(var i=0;i<urls.length;i++){if(Shield.queueSplineLoad)Shield.queueSplineLoad(urls[i],function(){});else SU.cacheScene(urls[i]);}},3000);
};
// Visibility observer
if('IntersectionObserver' in w){
  SU.visibilityObserver=new IntersectionObserver(function(entries){
    for(var i=0;i<entries.length;i++){
      var e=entries[i],c=e.target,u=c.getAttribute('data-spline-url');
      if(u&&SU.scenes[u])SU.scenes[u].visible=e.isIntersecting;
      emit('bullmoney-spline-visibility',{url:u,visible:e.isIntersecting,targetFPS:e.isIntersecting?targetFPS():Math.max(15,Math.floor(targetFPS()/3))});
    }
  },{rootMargin:'120px',threshold:[0,0.35,0.7,1]});
  onReady(function(){var nodes=d.querySelectorAll('[data-spline-scene], .spline-container');for(var i=0;i<nodes.length;i++)SU.visibilityObserver.observe(nodes[i]);});
}
// Spline CSS
var splineSty=d.createElement('style');splineSty.id='spline-universal-styles';
splineSty.textContent='.spline-container,.spline-scene-wrapper,[data-spline-scene]{contain:layout style paint;transform:translateZ(0);backface-visibility:hidden}.spline-loading::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,215,0,.03),transparent);animation:spline-shimmer 1.5s infinite;pointer-events:none}@keyframes spline-shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}.spline-loaded::after{display:none}.spline-container canvas{opacity:1!important;visibility:visible!important;pointer-events:auto!important}[data-spline-quality="high"] canvas,[data-spline-quality="ultra"] canvas{image-rendering:-webkit-optimize-contrast;image-rendering:crisp-edges}';
if(d.head)d.head.appendChild(splineSty);

function syncSpline(){
  var q=computeQuality(),fps=targetFPS();
  setAttr('data-spline-fps',String(fps));setAttr('data-spline-ready','true');
  w.__splineOptimize__={quality:q,scale:qualityScale(),maxTexture:textureLimit(),targetFPS:fps,alwaysRender:true};
}
syncSpline();
w.addEventListener('bm:memory',syncSpline);w.addEventListener('bm:network-strategy',syncSpline);w.addEventListener('bm:inapp',syncSpline);
SU.loaded=true;
if(isDev)console.log('[SPLINE] quality=',SU.quality,'fps=',targetFPS());

// ═══════════════════════════════════════════════════════════════
// 5. OFFLINE DETECT — branded banner
// ═══════════════════════════════════════════════════════════════
var wasOffline=false;
function isStorePage(){return /^\/store(\/|$)/.test(w.location.pathname||'');}
function isMobileVP(){return w.matchMedia&&w.matchMedia('(max-width:768px)').matches;}
function getHeaderOff(){
  if(!(isStorePage()&&isMobileVP()))return 0;
  var sels=['[data-store-header]','.store-header','header[role="banner"]','header'];
  for(var i=0;i<sels.length;i++){var el=d.querySelector(sels[i]);if(!el)continue;var r=el.getBoundingClientRect();if(r.height>0&&r.bottom>0)return Math.max(0,Math.round(r.bottom));}
  return 56;
}
function styleBar(bar){
  var top=getHeaderOff();
  bar.style.cssText='position:fixed;left:10px;right:10px;top:'+top+'px;padding:8px 10px;background:#000;color:#fff;border:1px solid rgba(255,255,255,.35);border-radius:10px;font-size:12px;z-index:100001;font-family:system-ui,-apple-system,sans-serif;display:flex;align-items:center;gap:8px;box-shadow:0 6px 20px rgba(0,0,0,.45)';
}
function ensureBar(){
  if(!d.body)return;var existing=d.getElementById('bm-offline-bar');
  if(existing){styleBar(existing);return existing;}
  var bar=d.createElement('div');bar.id='bm-offline-bar';
  bar.innerHTML='<img src="/ONcc2l601.svg" alt="BullMoney" width="16" height="16" style="display:block;filter:grayscale(1) brightness(0) invert(1);opacity:.95"/><span style="font-weight:600;letter-spacing:.01em">Offline mode</span><span style="opacity:.82">Some features may be limited.</span>';
  styleBar(bar);d.body.appendChild(bar);return bar;
}
function setOffline(){setAttr('data-online','false');if(!wasOffline){wasOffline=true;docEl.classList.add('is-offline');ensureBar();}}
function setOnline(){setAttr('data-online','true');if(wasOffline){wasOffline=false;docEl.classList.remove('is-offline');var bar=d.getElementById('bm-offline-bar');if(bar)bar.remove();}}
function checkOnline(){if(n.onLine)setOnline();else setOffline();}
w.addEventListener('online',checkOnline);w.addEventListener('offline',checkOnline);
w.addEventListener('resize',function(){var bar=d.getElementById('bm-offline-bar');if(bar)styleBar(bar);},{passive:true});
onReady(checkOnline);
setInterval(function(){if(!n.onLine||!('fetch' in w))return;fetch('/build-info.json',{cache:'no-store',method:'HEAD'}).then(function(r){if(!r.ok)throw 0;setOnline();}).catch(function(){setOffline();});},45000);

// ═══════════════════════════════════════════════════════════════
// BRAIN READY
// ═══════════════════════════════════════════════════════════════
B.ready=true;
emit('bm:brain-ready',{version:'3.0',modules:['inapp','network','memory','spline','offline']});
if(isDev)console.log('[BM BRAIN] v3.0 ready — all modules loaded in',Math.round(p.now())+'ms');
})();
