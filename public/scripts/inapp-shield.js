// BULLMONEY IN-APP BROWSER SHIELD v3.0 (auto-generated by boost.py)
// Protects against crashes in Instagram, TikTok, Facebook in-app browsers
(function(){
'use strict';
var w=window,d=document,n=navigator;
var ua=n.userAgent||'';
var S=w.__BM_INAPP_SHIELD__={active:false,browser:null,fixes:[]};
function onReady(fn){
  if(d.readyState==='loading')d.addEventListener('DOMContentLoaded',fn,{once:true});
  else fn();
}

// ─── 156. Detect Specific In-App Browser ───
var detections=[
  {name:'instagram',pattern:/instagram/i},
  {name:'tiktok',pattern:/tiktok|bytedance|musical_ly/i},
  {name:'facebook',pattern:/fban|fbav|fb_iab|facebook/i},
  {name:'twitter',pattern:/twitter/i},
  {name:'snapchat',pattern:/snapchat/i},
  {name:'linkedin',pattern:/linkedin/i},
  {name:'wechat',pattern:/micromessenger|wechat/i},
  {name:'line',pattern:/line\//i},
  {name:'telegram',pattern:/telegram/i},
  {name:'pinterest',pattern:/pinterest/i},
  {name:'reddit',pattern:/reddit/i},
  {name:'discord',pattern:/discord/i},
  {name:'webview-ios',pattern:/\bwv\b.*safari/i},
  {name:'webview-android',pattern:/\bwv\b/i},
];

for(var i=0;i<detections.length;i++){
  if(detections[i].pattern.test(ua)){
    S.browser=detections[i].name;
    S.active=true;
    break;
  }
}

if(!S.active)return; // Not an in-app browser, exit early

d.documentElement.setAttribute('data-inapp',S.browser);
d.documentElement.classList.add('in-app-browser');

// ─── 157. Reduce Heavy Features for In-App ───
// In-app browsers typically have 1-2GB memory limit and no WebGL2
// Keep 3D visible with no forced quality restriction
d.documentElement.classList.add('reduce-effects');
S.fixes.push('keep-3d');

// ─── 158. Fix Viewport Issues ───
// In-app browsers often have wrong viewport height (address bar confusion)
function fixViewport(){
  var h=(w.visualViewport&&w.visualViewport.height)||w.innerHeight;
  var ww=(w.visualViewport&&w.visualViewport.width)||w.innerWidth;
  var vh=h*0.01;
  var rootStyle=d.documentElement.style;
  rootStyle.setProperty('--vh',vh+'px');
  rootStyle.setProperty('--app-height',h+'px');
  rootStyle.setProperty('--app-width',ww+'px');
  if(!rootStyle.getPropertyValue('--safe-bottom'))rootStyle.setProperty('--safe-bottom','env(safe-area-inset-bottom,0px)');
}
fixViewport();
w.addEventListener('resize',fixViewport);
if('visualViewport' in w&&w.visualViewport){
  w.visualViewport.addEventListener('resize',fixViewport);
}
// Instagram iOS needs extra resize detection
var lastH=w.innerHeight;
var viewportInterval=setInterval(function(){
  if(w.innerHeight!==lastH){lastH=w.innerHeight;fixViewport();}
},500);
S.fixes.push('viewport-fix');
w.addEventListener('pagehide',function(){clearInterval(viewportInterval);});

// ─── 159. Prevent Scroll Locking ───
// In-app browsers often get stuck on overscroll
// Skip restrictive touch settings on games page
function applyScrollFix(){
  var isGamesPage=d.documentElement.hasAttribute('data-games-page')||d.body.hasAttribute('data-games-page')||w.location.pathname.startsWith('/games');
  if(!d.body)return;
  if(!isGamesPage){
    d.body.style.overscrollBehavior='none';
    d.documentElement.style.overscrollBehavior='none';
    // Prevent pull-to-refresh in in-app
    d.body.style.touchAction='pan-x pan-y';
    S.fixes.push('scroll-fix');
  }else{
    // Games page: allow free scrolling
    d.body.style.overscrollBehavior='auto';
    d.documentElement.style.overscrollBehavior='auto';
    d.body.style.touchAction='auto';
    if(S.fixes.indexOf('scroll-fix-games')===-1)S.fixes.push('scroll-fix-games');
  }
}
onReady(function(){
  applyScrollFix();
  // Re-check after React hydration (when data attribute is set)
  setTimeout(applyScrollFix,500);
  setTimeout(applyScrollFix,1500);
});

// ─── 160. Memory-Safe Image Loading ───
// Load smaller images in in-app browsers
onReady(function(){
  d.querySelectorAll('img[srcset]').forEach(function(img){
    // Force smallest srcset option
    var srcset=img.getAttribute('srcset');
    if(srcset){
      var srcs=srcset.split(',').map(function(s){return s.trim().split(/\s+/);});
      if(srcs.length>0){
        img.src=srcs[0][0]; // Use smallest image
        img.removeAttribute('srcset');
      }
    }
  });
});
S.fixes.push('image-downscale');

// ─── 161. Videos preserved (no longer disabled) ───
// Videos and GIFs are intentionally kept playing for user experience
S.fixes.push('video-preserved');

// ─── 162. Reduce Animation Complexity ───
// NEVER use display:none on content sections — user sees blank gaps
// NEVER use filter:none — breaks invert/brightness theming (black↔white glitch)
// NEVER use transform:none on * — breaks layout positioning
var inappStyle=d.createElement('style');
inappStyle.textContent=[
  '.in-app-browser *{animation-duration:0.15s!important;transition-duration:0.1s!important;}',
  // Only truly decorative particles get hidden (tiny elements, no content)
  '.in-app-browser .particle-container,.in-app-browser .confetti{opacity:0!important;pointer-events:none!important;height:0!important;overflow:hidden!important;}',
  // Aurora: fade to near-invisible but keep in layout flow
  '.in-app-browser .aurora{opacity:0.05!important;}',
  // Glass: opaque dark fallback (keeps text readable)
  '.in-app-browser .glass-effect,.in-app-browser .glassmorphism,.in-app-browser .glass-surface,.in-app-browser .glass-card{backdrop-filter:none!important;-webkit-backdrop-filter:none!important;background:rgba(5,9,21,0.85)!important;border-color:rgba(255,255,255,0.06)!important;}',
  '.in-app-browser [data-apple-section] .glass-effect,.in-app-browser [data-apple-section] .glassmorphism,.in-app-browser [data-apple-section] .glass-surface,.in-app-browser [data-apple-section] .glass-card{background:rgba(255,255,255,0.92)!important;border-color:rgba(0,0,0,0.08)!important;color:#0f172a!important;}',
  '.in-app-browser [data-products-section] .glass-effect,.in-app-browser [data-products-section] .glassmorphism,.in-app-browser [data-products-section] .glass-surface,.in-app-browser [data-products-section] .glass-card{background:rgba(255,255,255,0.92)!important;border-color:rgba(0,0,0,0.08)!important;color:#0f172a!important;}',
  '.in-app-browser .glass-effect.bg-white,.in-app-browser .glassmorphism.bg-white,.in-app-browser .glass-surface.bg-white,.in-app-browser .glass-card.bg-white{background:rgba(255,255,255,0.92)!important;border-color:rgba(0,0,0,0.08)!important;color:#0f172a!important;}',
  '.in-app-browser .glass-effect.bg-gray-50,.in-app-browser .glassmorphism.bg-gray-50,.in-app-browser .glass-surface.bg-gray-50,.in-app-browser .glass-card.bg-gray-50{background:rgba(255,255,255,0.92)!important;border-color:rgba(0,0,0,0.08)!important;color:#0f172a!important;}',
  '.in-app-browser .glass-effect.bg-neutral-50,.in-app-browser .glassmorphism.bg-neutral-50,.in-app-browser .glass-surface.bg-neutral-50,.in-app-browser .glass-card.bg-neutral-50{background:rgba(255,255,255,0.92)!important;border-color:rgba(0,0,0,0.08)!important;color:#0f172a!important;}',
  // Complex components: simplify but KEEP VISIBLE — reduce animations, keep content
  '.in-app-browser .circular-gallery{animation:none!important;overflow:hidden!important;}',
  '.in-app-browser .card-swap{animation:none!important;transition:none!important;}',
  '.in-app-browser .color-bends{animation:none!important;opacity:0.5!important;}',
].join('\n');
d.head.appendChild(inappStyle);
S.fixes.push('css-reduced');

// ─── 163. Safe External Link Handling ───
// In-app browsers often trap links; add target hints
d.addEventListener('click',function(e){
  var a=e.target.closest('a[href]');
  if(!a)return;
  var href=a.getAttribute('href')||'';
  // External links should open in default browser
  if(href.startsWith('http')&&href.indexOf(w.location.hostname)===-1){
    // Attempt to break out of in-app browser
    if(S.browser==='instagram'||S.browser==='tiktok'){
      e.preventDefault();
      // Try deep link to default browser
      w.open(href,'_system')||w.open(href,'_blank');
    }
  }
});
S.fixes.push('link-handling');

// ─── 164. Crash Recovery ───
// If the page crashes and reloads, detect it and go lighter
var crashKey='bm_inapp_crashes';
var crashes=parseInt(sessionStorage.getItem(crashKey)||'0',10);
if(crashes>0){
  // Page crashed before - go ultra-light mode
  // PRESERVE filter (theming) and transform (layout) — only strip animation/transition/box-shadow
  d.documentElement.classList.add('ultra-light-mode');
  var ultraStyle=d.createElement('style');
  ultraStyle.textContent=[
    // No filter:none (breaks invert/brightness theming = black/white glitch)
    // No transform:none (breaks translate/scale layout = elements pile up at 0,0)
    '.ultra-light-mode *{animation:none!important;transition:none!important;backdrop-filter:none!important;-webkit-backdrop-filter:none!important;}',
    '.ultra-light-mode *:not(.product-card-premium):not(input):not(button):not(a){box-shadow:none!important;}',
    '.ultra-light-mode img{image-rendering:auto;}',
    '.ultra-light-mode .hero{min-height:auto!important;height:auto!important;}',
    // Glass: opaque dark fallback so no transparent-over-black
    '.ultra-light-mode .glass-effect,.ultra-light-mode .glassmorphism,.ultra-light-mode .glass-surface,.ultra-light-mode .glass-card{background:rgba(5,9,21,0.88)!important;border-color:rgba(255,255,255,0.05)!important;}',
    '.ultra-light-mode [data-apple-section] .glass-effect,.ultra-light-mode [data-apple-section] .glassmorphism,.ultra-light-mode [data-apple-section] .glass-surface,.ultra-light-mode [data-apple-section] .glass-card{background:rgba(255,255,255,0.92)!important;border-color:rgba(0,0,0,0.08)!important;color:#0f172a!important;}',
    '.ultra-light-mode [data-products-section] .glass-effect,.ultra-light-mode [data-products-section] .glassmorphism,.ultra-light-mode [data-products-section] .glass-surface,.ultra-light-mode [data-products-section] .glass-card{background:rgba(255,255,255,0.92)!important;border-color:rgba(0,0,0,0.08)!important;color:#0f172a!important;}',
    '.ultra-light-mode .glass-effect.bg-white,.ultra-light-mode .glassmorphism.bg-white,.ultra-light-mode .glass-surface.bg-white,.ultra-light-mode .glass-card.bg-white{background:rgba(255,255,255,0.92)!important;border-color:rgba(0,0,0,0.08)!important;color:#0f172a!important;}',
    '.ultra-light-mode .glass-effect.bg-gray-50,.ultra-light-mode .glassmorphism.bg-gray-50,.ultra-light-mode .glass-surface.bg-gray-50,.ultra-light-mode .glass-card.bg-gray-50{background:rgba(255,255,255,0.92)!important;border-color:rgba(0,0,0,0.08)!important;color:#0f172a!important;}',
    '.ultra-light-mode .glass-effect.bg-neutral-50,.ultra-light-mode .glassmorphism.bg-neutral-50,.ultra-light-mode .glass-surface.bg-neutral-50,.ultra-light-mode .glass-card.bg-neutral-50{background:rgba(255,255,255,0.92)!important;border-color:rgba(0,0,0,0.08)!important;color:#0f172a!important;}',
  ].join('\n');
  d.head.appendChild(ultraStyle);
  S.fixes.push('crash-recovery-ultralight');
}
// Track this load as a potential crash (cleared on successful load)
sessionStorage.setItem(crashKey,String(crashes+1));
w.addEventListener('load',function(){
  // Loaded successfully - reset crash counter
  setTimeout(function(){sessionStorage.setItem(crashKey,'0');},3000);
});

// ─── 165-170. "Open in Browser" Banner ───
// Gentle nudge users to open in their real browser for best experience
if(S.browser==='instagram'||S.browser==='tiktok'||S.browser==='facebook'){
  w.addEventListener('load',function(){
    setTimeout(function(){
      if(d.getElementById('bm-open-browser'))return;
      if(!d.body)return;
      var bar=d.createElement('div');
      bar.id='bm-open-browser';
      bar.style.cssText='position:fixed;bottom:0;left:0;right:0;padding:10px 16px;background:linear-gradient(135deg,#1a1a2e,#0a0a0a);border-top:1px solid rgba(255,215,0,0.3);z-index:99999;display:flex;align-items:center;justify-content:space-between;gap:8px;font-family:system-ui,-apple-system,sans-serif;';
      bar.innerHTML='<span style="color:#ffd700;font-size:13px;">\u26a1 Open in browser for the best experience</span>'
        +'<div style="display:flex;gap:6px;">'
        +'<button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid rgba(255,255,255,0.2);color:#999;padding:4px 10px;border-radius:6px;font-size:12px;cursor:pointer;">Dismiss</button>'
        +'<a href="'+w.location.href+'" target="_blank" style="background:linear-gradient(135deg,#ffd700,#f59e0b);color:#000;padding:4px 12px;border-radius:6px;font-size:12px;text-decoration:none;font-weight:600;">Open</a>'
        +'</div>';
      d.body.appendChild(bar);
    },2000);
  });
  S.fixes.push('open-in-browser-banner');
}

if(w.location.hostname==='localhost'){
  console.log('%c[IN-APP SHIELD] Detected: '+S.browser+' | Fixes: '+S.fixes.join(', '),'color:#f59e0b;font-weight:bold');
}
})();
