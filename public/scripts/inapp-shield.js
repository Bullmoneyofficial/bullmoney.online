// BULLMONEY IN-APP BROWSER SHIELD v3.0 (auto-generated by boost.py)
// Protects against crashes in Instagram, TikTok, Facebook in-app browsers
(function(){
'use strict';
var w=window,d=document,n=navigator;
var ua=n.userAgent||'';
var S=w.__BM_INAPP_SHIELD__={active:false,browser:null,fixes:[]};

// ─── 156. Detect Specific In-App Browser ───
var detections=[
  {name:'instagram',pattern:/instagram/i},
  {name:'tiktok',pattern:/tiktok|bytedance|musical_ly/i},
  {name:'facebook',pattern:/fban|fbav|fb_iab|facebook/i},
  {name:'twitter',pattern:/twitter/i},
  {name:'snapchat',pattern:/snapchat/i},
  {name:'linkedin',pattern:/linkedin/i},
  {name:'wechat',pattern:/micromessenger|wechat/i},
  {name:'line',pattern:/line\//i},
  {name:'telegram',pattern:/telegram/i},
  {name:'pinterest',pattern:/pinterest/i},
  {name:'reddit',pattern:/reddit/i},
  {name:'discord',pattern:/discord/i},
  {name:'webview-ios',pattern:/\bwv\b.*safari/i},
  {name:'webview-android',pattern:/\bwv\b/i},
];

for(var i=0;i<detections.length;i++){
  if(detections[i].pattern.test(ua)){
    S.browser=detections[i].name;
    S.active=true;
    break;
  }
}

if(!S.active)return; // Not an in-app browser, exit early

d.documentElement.setAttribute('data-inapp',S.browser);
d.documentElement.classList.add('in-app-browser');

// ─── 157. Disable Heavy Features for In-App ───
// In-app browsers typically have 1-2GB memory limit and no WebGL2
d.documentElement.setAttribute('data-3d-quality','disabled');
d.documentElement.classList.add('reduce-effects');
S.fixes.push('disabled-3d');

// ─── 158. Fix Viewport Issues ───
// In-app browsers often have wrong viewport height (address bar confusion)
function fixViewport(){
  var vh=w.innerHeight*0.01;
  d.documentElement.style.setProperty('--vh',vh+'px');
  d.documentElement.style.setProperty('--app-height',w.innerHeight+'px');
  d.documentElement.style.setProperty('--safe-bottom','env(safe-area-inset-bottom,0px)');
}
fixViewport();
w.addEventListener('resize',fixViewport);
// Instagram iOS needs extra resize detection
var lastH=w.innerHeight;
setInterval(function(){
  if(w.innerHeight!==lastH){lastH=w.innerHeight;fixViewport();}
},500);
S.fixes.push('viewport-fix');

// ─── 159. Prevent Scroll Locking ───
// In-app browsers often get stuck on overscroll
d.body.style.overscrollBehavior='none';
d.documentElement.style.overscrollBehavior='none';
// Prevent pull-to-refresh in in-app
d.body.style.touchAction='pan-x pan-y';
S.fixes.push('scroll-fix');

// ─── 160. Memory-Safe Image Loading ───
// Load smaller images in in-app browsers
d.querySelectorAll('img[srcset]').forEach(function(img){
  // Force smallest srcset option
  var srcset=img.getAttribute('srcset');
  if(srcset){
    var srcs=srcset.split(',').map(function(s){return s.trim().split(/\s+/);});
    if(srcs.length>0){
      img.src=srcs[0][0]; // Use smallest image
      img.removeAttribute('srcset');
    }
  }
});
S.fixes.push('image-downscale');

// ─── 161. Videos preserved (no longer disabled) ───
// Videos and GIFs are intentionally kept playing for user experience
S.fixes.push('video-preserved');

// ─── 162. Reduce Animation Complexity ───
var inappStyle=d.createElement('style');
inappStyle.textContent=[
  '.in-app-browser *{animation-duration:0.15s!important;transition-duration:0.1s!important;}',
  // Spline, canvas, video, and GIFs are preserved - only hide decorative effects
  '.in-app-browser .particle-container,.in-app-browser .confetti,.in-app-browser .aurora{display:none!important;}',
  '.in-app-browser .glass-effect,.in-app-browser .glassmorphism{backdrop-filter:none!important;-webkit-backdrop-filter:none!important;background:rgba(0,0,0,0.85)!important;}',
  // Simplify complex layouts that crash in-app browsers
  '.in-app-browser .circular-gallery,.in-app-browser .card-swap{display:none!important;}',
  '.in-app-browser .color-bends{display:none!important;}',
].join('\n');
d.head.appendChild(inappStyle);
S.fixes.push('css-reduced');

// ─── 163. Safe External Link Handling ───
// In-app browsers often trap links; add target hints
d.addEventListener('click',function(e){
  var a=e.target.closest('a[href]');
  if(!a)return;
  var href=a.getAttribute('href')||'';
  // External links should open in default browser
  if(href.startsWith('http')&&href.indexOf(w.location.hostname)===-1){
    // Attempt to break out of in-app browser
    if(S.browser==='instagram'||S.browser==='tiktok'){
      e.preventDefault();
      // Try deep link to default browser
      w.open(href,'_system')||w.open(href,'_blank');
    }
  }
});
S.fixes.push('link-handling');

// ─── 164. Crash Recovery ───
// If the page crashes and reloads, detect it and go lighter
var crashKey='bm_inapp_crashes';
var crashes=parseInt(sessionStorage.getItem(crashKey)||'0',10);
if(crashes>0){
  // Page crashed before - go ultra-light mode
  d.documentElement.classList.add('ultra-light-mode');
  var ultraStyle=d.createElement('style');
  ultraStyle.textContent=[
    '.ultra-light-mode *{animation:none!important;transition:none!important;transform:none!important;filter:none!important;box-shadow:none!important;}',
    '.ultra-light-mode img{image-rendering:auto;}',
    '.ultra-light-mode .hero{min-height:auto!important;height:auto!important;}',
  ].join('\n');
  d.head.appendChild(ultraStyle);
  S.fixes.push('crash-recovery-ultralight');
}
// Track this load as a potential crash (cleared on successful load)
sessionStorage.setItem(crashKey,String(crashes+1));
w.addEventListener('load',function(){
  // Loaded successfully - reset crash counter
  setTimeout(function(){sessionStorage.setItem(crashKey,'0');},3000);
});

// ─── 165-170. "Open in Browser" Banner ───
// Gentle nudge users to open in their real browser for best experience
if(S.browser==='instagram'||S.browser==='tiktok'||S.browser==='facebook'){
  w.addEventListener('load',function(){
    setTimeout(function(){
      if(d.getElementById('bm-open-browser'))return;
      var bar=d.createElement('div');
      bar.id='bm-open-browser';
      bar.style.cssText='position:fixed;bottom:0;left:0;right:0;padding:10px 16px;background:linear-gradient(135deg,#1a1a2e,#0a0a0a);border-top:1px solid rgba(255,215,0,0.3);z-index:99999;display:flex;align-items:center;justify-content:space-between;gap:8px;font-family:system-ui,-apple-system,sans-serif;';
      bar.innerHTML='<span style="color:#ffd700;font-size:13px;">\u26a1 Open in browser for the best experience</span>'
        +'<div style="display:flex;gap:6px;">'
        +'<button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid rgba(255,255,255,0.2);color:#999;padding:4px 10px;border-radius:6px;font-size:12px;cursor:pointer;">Dismiss</button>'
        +'<a href="'+w.location.href+'" target="_blank" style="background:linear-gradient(135deg,#ffd700,#f59e0b);color:#000;padding:4px 12px;border-radius:6px;font-size:12px;text-decoration:none;font-weight:600;">Open</a>'
        +'</div>';
      d.body.appendChild(bar);
    },2000);
  });
  S.fixes.push('open-in-browser-banner');
}

if(w.location.hostname==='localhost'){
  console.log('%c[IN-APP SHIELD] Detected: '+S.browser+' | Fixes: '+S.fixes.join(', '),'color:#f59e0b;font-weight:bold');
}
})();