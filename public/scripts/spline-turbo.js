// BULLMONEY SPLINE TURBO v3.0 (auto-generated by boost.py)
// Maximizes 3D performance, prevents crashes on low-memory devices
(function(){
'use strict';
var w=window,d=document,n=navigator;
var ST=w.__BM_SPLINE_TURBO__={loaded:false,scenes:{},disposed:[],fallbackActive:false};

// ─── 106. WebGL Context Pre-Warming ───
// Create and cache a WebGL context early so Spline doesn't have cold-start lag
(function preWarmWebGL(){
  try{
    var c=d.createElement('canvas');c.width=1;c.height=1;
    var gl=c.getContext('webgl2',{powerPreference:'high-performance',antialias:false,alpha:false,stencil:false,depth:false})
      ||c.getContext('webgl',{powerPreference:'high-performance',antialias:false});
    if(gl){
      ST.webglReady=true;ST.webglVersion=gl.getParameter(gl.VERSION);
      // Get GPU info for quality decisions
      var dbg=gl.getExtension('WEBGL_debug_renderer_info');
      if(dbg){ST.gpu=gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL)||'unknown';}
      // Pre-compile a trivial shader to warm the pipeline
      var vs=gl.createShader(gl.VERTEX_SHADER);
      gl.shaderSource(vs,'attribute vec4 p;void main(){gl_Position=p;}');
      gl.compileShader(vs);
      var fs=gl.createShader(gl.FRAGMENT_SHADER);
      gl.shaderSource(fs,'precision lowp float;void main(){gl_FragColor=vec4(1);}');
      gl.compileShader(fs);
      var pg=gl.createProgram();gl.attachShader(pg,vs);gl.attachShader(pg,fs);gl.linkProgram(pg);
      gl.deleteProgram(pg);gl.deleteShader(vs);gl.deleteShader(fs);
      // Don't lose the context - let GC handle it
      ST._warmCanvas=c;
    } else { ST.webglReady=false; }
  }catch(e){ST.webglReady=false;}
})();

// ─── 107. Device-Aware Quality Tiers for 3D ───
var DEV=w.__BM_DEVICE__||{};
var mem=DEV.memory||n.deviceMemory||4;
var cores=DEV.cores||n.hardwareConcurrency||4;
var dpr=w.devicePixelRatio||1;
var isMobile=DEV.device==='mobile'||(typeof matchMedia!=='undefined'&&matchMedia('(pointer:coarse)').matches);
var conn=(n.connection||n.mozConnection||n.webkitConnection||{});
var saveData=conn.saveData||false;
var slowNet=conn.effectiveType==='2g'||conn.effectiveType==='slow-2g';
var isInApp=/instagram|fbav|fban|fb_iab|tiktok|bytedance|twitter|snapchat|linkedin|wechat|line\//i.test(n.userAgent);

// Calculate 3D quality tier
var q3d='high';
if(!ST.webglReady){q3d='disabled';}
else if(saveData||slowNet){q3d=isMobile?'low':'disabled';}
else if(mem<2){q3d=isMobile?'low':'disabled';}
else if(isInApp){q3d='low';}
else if(mem<3||cores<2){q3d='low';}
else if(isMobile&&mem<6){q3d='medium';}
else if(mem>=8&&cores>=6&&!isMobile){q3d='ultra';}

ST.quality=q3d;
d.documentElement.setAttribute('data-3d-quality',q3d);

// ─── 108. Spline Scene Resolution Scaler ───
// Reduce canvas resolution on lower tiers to save GPU memory
ST.getCanvasScale=function(){
  var scales={ultra:Math.min(dpr,2),high:Math.min(dpr,1.5),medium:1,low:0.75,disabled:0};
  return scales[q3d]||1;
};
ST.getMaxTextureSize=function(){
  var sizes={ultra:4096,high:2048,medium:1024,low:512,disabled:0};
  return sizes[q3d]||1024;
};

// ─── 109. GPU Memory Budget Tracker ───
ST.gpuMemoryBudgetMB=(function(){
  if(q3d==='ultra')return 512;
  if(q3d==='high')return 256;
  if(q3d==='medium')return 128;
  if(q3d==='low')return 64;
  return 0;
})();
ST.gpuMemoryUsedMB=0;
ST.trackGPUAlloc=function(sceneName,sizeMB){
  ST.gpuMemoryUsedMB+=sizeMB;
  ST.scenes[sceneName]={sizeMB:sizeMB,loaded:Date.now(),visible:true};
  if(ST.gpuMemoryUsedMB>ST.gpuMemoryBudgetMB*0.85){
    // Over budget - dispose least recently used scene
    w.dispatchEvent(new CustomEvent('bullmoney-gpu-pressure',{detail:{used:ST.gpuMemoryUsedMB,budget:ST.gpuMemoryBudgetMB}}));
  }
};

// ─── 110. Spline Runtime Preload via Service Worker ───
if('serviceWorker' in n&&q3d!=='disabled'){
  n.serviceWorker.ready.then(function(reg){
    if(reg.active){
      reg.active.postMessage({type:'PREFETCH_SPLINE',urls:[
        'https://unpkg.com/@splinetool/runtime/build/runtime.js',
      ]});
    }
  }).catch(function(){});
}

// ─── 113. Progressive Scene Loading Coordinator ───
// Shows instant gradient placeholder → loads low-quality preview → upgrades to full
ST.loadScene=function(container,sceneUrl,opts){
  opts=opts||{};
  if(q3d==='disabled'){
    container.classList.add('spline-fallback-active');
    ST.fallbackActive=true;
    return Promise.resolve(null);
  }
  // Phase 1: Instant gradient placeholder (already in CSS)
  container.classList.add('spline-loading');
  // Phase 2: Load scene at reduced quality
  var scale=ST.getCanvasScale();
  return new Promise(function(resolve){
    // Signal the React component to load with quality settings
    container.setAttribute('data-spline-quality',q3d);
    container.setAttribute('data-spline-scale',scale);
    container.setAttribute('data-spline-max-texture',ST.getMaxTextureSize());
    // Track timing
    var start=performance.now();
    container.addEventListener('spline-loaded',function onLoad(){
      container.removeEventListener('spline-loaded',onLoad);
      container.classList.remove('spline-loading');
      container.classList.add('spline-loaded');
      var elapsed=Math.round(performance.now()-start);
      ST.scenes[sceneUrl]={loaded:Date.now(),loadTime:elapsed,visible:true,sizeMB:opts.sizeMB||20};
      ST.gpuMemoryUsedMB+=(opts.sizeMB||20);
      if(w.location.hostname==='localhost'){
        console.log('[SPLINE TURBO] '+sceneUrl+' loaded in '+elapsed+'ms (quality: '+q3d+')');
      }
      resolve(elapsed);
    },{once:true});
    // Timeout fallback - if scene doesn't load in 8s, show static fallback
    setTimeout(function(){
      if(container.classList.contains('spline-loading')){
        container.classList.remove('spline-loading');
        container.classList.add('spline-fallback-active');
        ST.fallbackActive=true;
        resolve(null);
      }
    },opts.timeout||8000);
  });
};

// ─── 114. Frame Rate: Adaptive target (mobile-lightweight) ───
var targetFPS=120;
if(isMobile||isInApp){
  targetFPS=(q3d==='low'||q3d==='disabled')?45:60;
} else if(q3d==='low'){targetFPS=60;}
else if(q3d==='medium'){targetFPS=90;}
ST.targetFPS=targetFPS;
d.documentElement.setAttribute('data-3d-fps',String(targetFPS));
// Only attempt high refresh rate hints on desktop/high tiers
if(targetFPS>=90&&!isMobile&&!isInApp){
  (function forceHighFps(){
    // Request high refresh rate via canvas hack
    try{
      var hfr=d.createElement('canvas');
      hfr.width=1;hfr.height=1;
      hfr.style.cssText='position:fixed;top:-9999px;pointer-events:none;opacity:0;';
      d.documentElement.appendChild(hfr);
      var ctx=hfr.getContext('2d');
      // Continuous rAF loop to hint browser we want max refresh rate
      var running=true;
      function tick(){
        if(!running)return;
        ctx.clearRect(0,0,1,1);
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
      // Cleanup after 10s - browser should have locked to high refresh by then
      setTimeout(function(){running=false;hfr.remove();},10000);
    }catch(e){}
    // Force screen.updateInterval if supported (some Chromium)
    if(w.screen&&w.screen.updateInterval!==undefined){
      try{w.screen.updateInterval=0;}catch(e){}
    }
  })();
}

// ─── 115. CSS for 3D Performance ───
var style=d.createElement('style');
style.textContent=[
  // GPU-accelerated containers
  '.spline-container,.spline-scene-wrapper,[data-spline-scene]{contain:layout style paint;will-change:auto;backface-visibility:hidden;}',
  // Fallback gradient for disabled/loading states - use semi-transparent overlay instead of forcing dark
  '.spline-fallback-active::after,.spline-loading::after{content:"";position:absolute;inset:0;background:rgba(128,128,128,0.1);pointer-events:none;}',
  '.spline-loading::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,215,0,0.05),transparent);animation:spline-shimmer 1.5s infinite;}',
  '@keyframes spline-shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}',
  // Reduce canvas resolution on lower tiers
  '[data-3d-quality="low"] canvas,[data-3d-quality="medium"] canvas{image-rendering:auto;}',
  '[data-3d-quality="low"] .spline-container canvas{max-width:100%;height:auto!important;}',
  // Disabled tier - reduce quality but keep visible (fallback shown on top)
  '[data-3d-quality="disabled"] .spline-container,[data-3d-quality="disabled"] spline-viewer,[data-3d-quality="disabled"] [data-spline-scene]{opacity:0.7;pointer-events:none;}',
  '[data-3d-quality="disabled"] .spline-fallback{display:block!important;}',
  // Off-screen - keep animations running
  '.spline-offscreen canvas{animation-play-state:running!important;}',
  // Tab hidden - keep animations running
  '.tab-hidden .spline-container,.tab-hidden [data-spline-scene]{animation-play-state:running!important;transition:none!important;}',
  '.tab-hidden canvas{animation-play-state:running!important;}',
  // Reduce motion preference
  '@media(prefers-reduced-motion:reduce){.spline-container,.spline-scene-wrapper{animation:none!important;transition:none!important;}}',
].join('\n');
d.head.appendChild(style);

// ─── 116-120. Spline Cache Manager (Cache API + IndexedDB) ───
ST.cacheScene=function(url){
  if(!('caches' in w))return Promise.resolve(false);
  return caches.open('bullmoney-spline-v3').then(function(cache){
    return cache.match(url).then(function(resp){
      if(resp)return true; // already cached
      return fetch(url,{mode:'cors',cache:'force-cache'}).then(function(r){
        if(r.ok)cache.put(url,r);
        return r.ok;
      }).catch(function(){return false;});
    });
  }).catch(function(){return false;});
};

// Pre-cache primary scenes on idle
if(q3d!=='disabled'&&'requestIdleCallback' in w){
  requestIdleCallback(function(){
    ['/scene1.splinecode','/scene3.splinecode'].forEach(function(url){
      ST.cacheScene(url);
    });
  },{timeout:5000});
}

// ─── 121-125. Adaptive 3D LOD System ───
// Dynamically downgrades scene quality if FPS drops
ST.enableAdaptiveLOD=function(){
  if(q3d==='disabled'||q3d==='low')return;
  var samples=[];var lastCheck=performance.now();
  function checkFPS(ts){
    samples.push(ts);
    if(samples.length>60){samples.shift();}
    if(ts-lastCheck>3000&&samples.length>=30){
      var avgFrame=(samples[samples.length-1]-samples[0])/(samples.length-1);
      var fps=Math.round(1000/avgFrame);
      if(fps<20&&q3d!=='low'){
        // Downgrade quality
        q3d=q3d==='ultra'?'high':q3d==='high'?'medium':'low';
        ST.quality=q3d;
        d.documentElement.setAttribute('data-3d-quality',q3d);
        w.dispatchEvent(new CustomEvent('bullmoney-3d-quality-change',{detail:{quality:q3d,fps:fps}}));
      }
      lastCheck=ts;
    }
    if(q3d!=='disabled')requestAnimationFrame(checkFPS);
  }
  requestAnimationFrame(checkFPS);
};
if(q3d!=='disabled')ST.enableAdaptiveLOD();

ST.loaded=true;
if(w.location.hostname==='localhost'){
  console.log('%c[SPLINE TURBO] Quality: '+q3d+' | GPU Budget: '+ST.gpuMemoryBudgetMB+'MB | Target FPS: '+ST.targetFPS+' | WebGL: '+(ST.webglReady?'ready':'unavailable'),'color:#ffd700;font-weight:bold');
}
})();