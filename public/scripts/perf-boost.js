// BOOST: Advanced Performance Monitor (auto-generated by boost.py)
(function(){
  'use strict';
  var M=window.__BM_PERF__={};
  var startTime=performance.now();

  // 91. Navigation Timing
  window.addEventListener('load',function(){
    setTimeout(function(){
      var t=performance.getEntriesByType('navigation')[0];
      if(t){
        M.dns=Math.round(t.domainLookupEnd-t.domainLookupStart);
        M.tcp=Math.round(t.connectEnd-t.connectStart);
        M.ttfb=Math.round(t.responseStart-t.requestStart);
        M.download=Math.round(t.responseEnd-t.responseStart);
        M.domParse=Math.round(t.domInteractive-t.responseEnd);
        M.domReady=Math.round(t.domContentLoadedEventEnd-t.fetchStart);
        M.fullLoad=Math.round(t.loadEventEnd-t.fetchStart);
        M.redirect=Math.round(t.redirectEnd-t.redirectStart);
        M.tls=t.secureConnectionStart>0?Math.round(t.connectEnd-t.secureConnectionStart):0;
      }
    },100);
  });

  // 92. Resource Loading Analysis
  window.addEventListener('load',function(){
    setTimeout(function(){
      var resources=performance.getEntriesByType('resource');
      var byType={};
      var totalTransfer=0;
      resources.forEach(function(r){
        var ext=(r.name.split('?')[0].split('.').pop()||'other').toLowerCase();
        if(!byType[ext])byType[ext]={count:0,size:0,time:0};
        byType[ext].count++;
        byType[ext].size+=(r.transferSize||0);
        byType[ext].time+=r.duration;
        totalTransfer+=(r.transferSize||0);
      });
      M.resources={byType:byType,total:resources.length,transferKB:Math.round(totalTransfer/1024)};
      
      // Find slowest resources
      var slow=resources.filter(function(r){return r.duration>500}).map(function(r){
        return {name:r.name.split('/').pop().split('?')[0],duration:Math.round(r.duration),size:Math.round((r.transferSize||0)/1024)};
      }).sort(function(a,b){return b.duration-a.duration}).slice(0,5);
      M.slowResources=slow;
    },500);
  });

  // 93. Long Task Detection
  if('PerformanceObserver' in window){
    var longTasks=[];
    try{
      new PerformanceObserver(function(l){
        l.getEntries().forEach(function(e){
          longTasks.push({duration:Math.round(e.duration),start:Math.round(e.startTime)});
        });
        M.longTasks=longTasks;
      }).observe({type:'longtask',buffered:true});
    }catch(e){}
  }

  // 94. Memory Usage Tracking
  if(performance.memory){
    setInterval(function(){
      M.memory={
        usedMB:Math.round(performance.memory.usedJSHeapSize/1048576),
        totalMB:Math.round(performance.memory.totalJSHeapSize/1048576),
        limitMB:Math.round(performance.memory.jsHeapSizeLimit/1048576),
        pct:Math.round((performance.memory.usedJSHeapSize/performance.memory.jsHeapSizeLimit)*100)
      };
      if(M.memory.pct>80)document.documentElement.classList.add('high-memory');
    },5000);
  }

  // 95. Frame Rate Monitor (ALL devices - targeting 120fps)
  var device=window.__BM_DEVICE__;
  if(true){
    var frames=0,lastTime=performance.now(),fps=60;
    function measureFPS(){
      frames++;
      var now=performance.now();
      if(now-lastTime>=1000){
        fps=Math.round(frames*1000/(now-lastTime));
        frames=0;lastTime=now;
        M.fps=fps;
        if(fps<30)document.documentElement.classList.add('low-fps');
        else document.documentElement.classList.remove('low-fps');
        updateFpsBoost(fps);
      }
      requestAnimationFrame(measureFPS);
    }
    requestAnimationFrame(measureFPS);
  }

  // 95b. FPS Booster (adaptive, keeps ALL content visible on ALL devices)
  var fpsBoost={level:'normal',low:0,high:0};
  function setFpsTierClass(tier){
    var root=document.documentElement;
    root.classList.remove('fps-ultra','fps-high','fps-medium','fps-low','fps-minimal');
    root.classList.add(tier);
  }
  function setFpsBoost(level){
    if(fpsBoost.level===level)return;
    fpsBoost.level=level;
    var root=document.documentElement;
    root.setAttribute('data-fps-tier',level);
    if(level==='boost'){
      root.classList.add('fps-boost');
      root.style.setProperty('--animation-duration','0.2s');
      root.style.setProperty('--transition-speed','0.12s');
      root.style.setProperty('--blur-amount','6px');
      root.style.setProperty('--particle-count','80');
    } else if(level==='critical'){
      root.classList.add('fps-boost');
      root.style.setProperty('--animation-duration','0.12s');
      root.style.setProperty('--transition-speed','0.08s');
      root.style.setProperty('--blur-amount','2px');
      root.style.setProperty('--particle-count','40');
    } else {
      root.classList.remove('fps-boost');
      root.style.removeProperty('--animation-duration');
      root.style.removeProperty('--transition-speed');
      root.style.removeProperty('--blur-amount');
      root.style.removeProperty('--particle-count');
    }
  }
  function updateFpsBoost(fps){
    if(document.documentElement.classList.contains('reduce-motion'))return;
    var tier=fps>=70?'fps-ultra':fps>=55?'fps-high':fps>=45?'fps-medium':fps>=30?'fps-low':'fps-minimal';
    setFpsTierClass(tier);
    if(fps<35){fpsBoost.low++;fpsBoost.high=0;}
    else if(fps>55){fpsBoost.high++;fpsBoost.low=0;}
    else {fpsBoost.low=Math.max(0,fpsBoost.low-1);fpsBoost.high=Math.max(0,fpsBoost.high-1);}
    if(fpsBoost.low>=3){
      setFpsBoost(fps<25?'critical':'boost');
    } else if(fpsBoost.high>=4){
      setFpsBoost('normal');
    }
  }

  // 96. Hydration Time Tracking
  M.boostLoadTime=performance.now();
  var hydrationStart=0;
  var observer=new MutationObserver(function(mutations){
    if(!hydrationStart){
      hydrationStart=performance.now();
      M.hydrationStart=hydrationStart;
    }
    // Detect React hydration complete (data-reactroot or __next content)
    var root=document.getElementById('__next');
    if(root&&root.children.length>0&&!M.hydrationEnd){
      M.hydrationEnd=performance.now();
      M.hydrationDuration=Math.round(M.hydrationEnd-hydrationStart);
      observer.disconnect();
    }
  });
  observer.observe(document.body||document.documentElement,{childList:true,subtree:true});

  // 97. Scroll Depth Tracking (for engagement metrics)
  var maxScroll=0;
  var ticking=false;
  window.addEventListener('scroll',function(){
    if(!ticking){
      requestAnimationFrame(function(){
        var scrollPct=Math.round((window.scrollY/(document.documentElement.scrollHeight-window.innerHeight))*100);
        if(scrollPct>maxScroll)maxScroll=scrollPct;
        M.maxScrollDepth=maxScroll;
        ticking=false;
      });
      ticking=true;
    }
  },{passive:true});

  // 98. Error Rate Tracking
  var errors=[];
  window.addEventListener('error',function(e){
    errors.push({msg:e.message,file:(e.filename||'').split('/').pop(),line:e.lineno,time:Date.now()});
    M.errors=errors;
    M.errorRate=errors.length;
  });
  window.addEventListener('unhandledrejection',function(e){
    errors.push({msg:String(e.reason).substring(0,100),type:'promise',time:Date.now()});
    M.errors=errors;
  });

  // 99. Time to Interactive (custom)
  window.addEventListener('load',function(){
    // Wait for idle to measure true interactive time
    if('requestIdleCallback' in window){
      requestIdleCallback(function(){
        M.tti=Math.round(performance.now());
      });
    } else {
      setTimeout(function(){M.tti=Math.round(performance.now())},200);
    }
  });

  // 100. Performance Score Calculator
  window.addEventListener('load',function(){
    setTimeout(function(){
      var score=100;
      // Penalize slow TTFB
      if(M.ttfb>600)score-=15;else if(M.ttfb>200)score-=5;
      // Penalize slow full load
      if(M.fullLoad>5000)score-=20;else if(M.fullLoad>3000)score-=10;
      // Penalize long tasks
      if(M.longTasks&&M.longTasks.length>5)score-=10;
      else if(M.longTasks&&M.longTasks.length>2)score-=5;
      // Penalize high memory
      if(M.memory&&M.memory.pct>80)score-=10;
      // Penalize slow hydration
      if(M.hydrationDuration>2000)score-=15;
      else if(M.hydrationDuration>1000)score-=5;
      // Penalize errors
      if(M.errorRate>3)score-=10;
      // Penalize large transfer
      if(M.resources&&M.resources.transferKB>3000)score-=10;
      
      M.score=Math.max(0,Math.min(100,score));
      M.grade=M.score>=90?'A':M.score>=75?'B':M.score>=60?'C':M.score>=40?'D':'F';
      
      // Set as data attribute for CSS-based perf indicators
      document.documentElement.setAttribute('data-perf-score',M.score);
      document.documentElement.setAttribute('data-perf-grade',M.grade);
      
      // Log summary in dev
      if(window.location.hostname==='localhost'){
        console.log('%c[BOOST] Performance Score: '+M.score+'/100 ('+M.grade+')','color:#22c55e;font-weight:bold;font-size:14px');
        console.table({
          TTFB:M.ttfb+'ms',
          'Full Load':M.fullLoad+'ms',
          'Hydration':M.hydrationDuration+'ms',
          'TTI':M.tti+'ms',
          'Transfer':((M.resources||{}).transferKB||0)+'KB',
          'Long Tasks':(M.longTasks||[]).length,
          'Errors':M.errorRate||0
        });
      }
    },3000);
  });

  // BONUS 101. Adaptive Quality - LOW MEMORY = FULL EXPERIENCE (desktop-like at <1024px)
  // On low-memory/low-perf devices: keep ALL content visible, only optimize render cost
  requestIdleCallback(function(){
    var d=window.__BM_DEVICE__||{};
    var perf=d.perfTier||'mid';
    var root=document.documentElement;
    var mem=d.memory||4;
    var isLowMem=mem<=2||perf==='low';
    var isMobileVP=window.innerWidth<1024;

    if(isLowMem){
      // LOW MEMORY ADAPTATION: show EVERYTHING, just lighten render cost
      root.classList.add('low-memory-adapt');
      root.setAttribute('data-low-memory','full-experience');
      root.style.setProperty('--animation-duration','0.15s');
      root.style.setProperty('--transition-speed','0.1s');
      root.style.setProperty('--blur-amount','0px');
      root.style.setProperty('--particle-count','20');
      root.style.setProperty('--shadow-complexity','simple');
      // Force GPU compositing for smooth scroll
      root.style.setProperty('--gpu-hint','translateZ(0)');
      // Keep videos as poster-only (saves memory, still visible)
      document.querySelectorAll('video[autoplay]').forEach(function(v){
        v.pause();v.preload='none';
        if(v.poster){v.removeAttribute('autoplay');v.setAttribute('data-low-mem-paused','1');}
      });
      // Downsize images to save memory but keep visible
      document.querySelectorAll('img[srcset]').forEach(function(img){
        img.sizes='(max-width:1024px) 80vw, 40vw';
      });
      // Play videos on tap (user-initiated = less memory pressure)
      document.addEventListener('click',function(e){
        var v=e.target.closest('video[data-low-mem-paused]');
        if(v){v.play();v.removeAttribute('data-low-mem-paused');}
      });
    } else if(d.saveData){
      root.classList.add('save-data-adapt');
      root.style.setProperty('--animation-duration','0.1s');
      root.style.setProperty('--transition-speed','0.05s');
      root.style.setProperty('--blur-amount','0px');
      root.style.setProperty('--particle-count','0');
    } else if(perf==='mid'){
      root.style.setProperty('--animation-duration','0.3s');
      root.style.setProperty('--transition-speed','0.15s');
      root.style.setProperty('--blur-amount','8px');
      root.style.setProperty('--particle-count','50');
    } else {
      root.style.setProperty('--animation-duration','0.5s');
      root.style.setProperty('--transition-speed','0.3s');
      root.style.setProperty('--blur-amount','20px');
      root.style.setProperty('--particle-count','200');
    }

    // MOBILE VERTICAL (<1024px) FULL DESKTOP EXPERIENCE
    if(isMobileVP){
      root.classList.add('mobile-full-experience');
      root.setAttribute('data-mobile-mode','full');
      // Ensure no content is hidden just because viewport is narrow
      root.style.setProperty('--content-visibility','visible');
      root.style.setProperty('--mobile-section-display','block');
    }
  });

  // BONUS 102. Preload critical API routes after idle
  requestIdleCallback(function(){
    ['/api/health'].forEach(function(url){
      fetch(url,{method:'HEAD',cache:'no-store'}).catch(function(){});
    });
  });

  // BONUS 103. Automatic dark/light image switching
  if(window.matchMedia){
    var mq=window.matchMedia('(prefers-color-scheme: dark)');
    function updateScheme(e){
      document.documentElement.setAttribute('data-scheme',e.matches?'dark':'light');
    }
    updateScheme(mq);
    mq.addEventListener('change',updateScheme);
  }

  // BONUS 104. Keyboard navigation detection
  window.addEventListener('keydown',function(e){
    if(e.key==='Tab')document.documentElement.classList.add('keyboard-nav');
  });
  window.addEventListener('mousedown',function(){
    document.documentElement.classList.remove('keyboard-nav');
  });

  // BONUS 105. Print optimization
  window.addEventListener('beforeprint',function(){
    document.documentElement.classList.add('printing');
  });
  window.addEventListener('afterprint',function(){
    document.documentElement.classList.remove('printing');
  });

})();