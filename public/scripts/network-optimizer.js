// BULLMONEY NETWORK WATERFALL OPTIMIZER v3.0 (auto-generated by boost.py)
// Intelligently prioritizes resource loading based on network conditions
(function(){
'use strict';
var w=window,d=document,n=navigator;
var NW=w.__BM_NETWORK__={strategy:'normal',prefetched:new Set(),priorities:{}};
var docEl=d.documentElement;
function onReady(fn){
  if(d.readyState==='loading')d.addEventListener('DOMContentLoaded',fn,{once:true});
  else fn();
}
function ric(cb,opts){
  if('requestIdleCallback' in w)return w.requestIdleCallback(cb,opts||{});
  var timeout=(opts&&opts.timeout)||1000;
  return setTimeout(function(){cb({didTimeout:true,timeRemaining:function(){return 0;}});},timeout);
}

// ─── 321. Network Condition Monitor ───
var conn=n.connection||n.mozConnection||n.webkitConnection||{};
function updateStrategy(){
  var type=conn.effectiveType||'4g';
  var saveData=conn.saveData||false;
  var downlink=conn.downlink||10;

  if(saveData){NW.strategy='minimal';}
  else if(type==='slow-2g'||type==='2g'){NW.strategy='minimal';}
  else if(type==='3g'||downlink<1.5){NW.strategy='conservative';}
  else if(type==='4g'&&downlink>=5){NW.strategy='aggressive';}
  else{NW.strategy='normal';}

  if(docEl)docEl.setAttribute('data-network-strategy',NW.strategy);
  NW.effectiveType=type;
  NW.downlinkMbps=downlink;
  NW.saveData=saveData;
}
updateStrategy();
if(conn.addEventListener)conn.addEventListener('change',updateStrategy);
else if('onchange' in conn)conn.onchange=updateStrategy;

// ─── 322. Priority-Based Resource Loader ───
NW.loadResource=function(url,type,priority){
  priority=priority||'low';
  NW.priorities[url]=priority;

  if(NW.strategy==='minimal'&&priority==='low')return Promise.resolve(null);
  if(NW.strategy==='conservative'&&priority==='low'){
    // Defer low-priority in conservative mode
    return new Promise(function(resolve){
      ric(function(){
        resolve(NW._doLoad(url,type));
      },{timeout:5000});
    });
  }
  return NW._doLoad(url,type);
};

NW._doLoad=function(url,type){
  if(d.querySelector('link[href="'+url+'"]'))return Promise.resolve(url);
  var link=d.createElement('link');
  if(type==='style'){link.rel='preload';link.as='style';}
  else if(type==='script'){link.rel='preload';link.as='script';}
  else if(type==='image'){link.rel='preload';link.as='image';}
  else if(type==='font'){link.rel='preload';link.as='font';link.crossOrigin='anonymous';}
  else{link.rel='prefetch';}
  link.href=url;
  if(d.head)d.head.appendChild(link);
  else onReady(function(){if(d.head)d.head.appendChild(link);});
  return Promise.resolve(url);
};

// ─── 323. Predictive Route Prefetcher ───
// Predicts which page the user will visit next based on current page
var predictions={
  '/':['/about','/shop','/Blogs','/community'],
  '/shop':['/store','/products','/Prop'],
  '/about':['/socials','/community','/recruit'],
  '/Blogs':['/','/community'],
  '/store':['/products','/shop'],
  '/community':['/socials','/course'],
  '/course':['/Prop','/community'],
};

var currentPath=w.location.pathname;
var predicted=predictions[currentPath]||[];

if(NW.strategy!=='minimal'){
  // Prefetch predicted routes after idle
  ric(function(){
    var limit=NW.strategy==='aggressive'?4:NW.strategy==='normal'?2:1;
    predicted.slice(0,limit).forEach(function(route){
      if(!NW.prefetched.has(route)){
        NW.prefetched.add(route);
        var link=d.createElement('link');
        link.rel='prefetch';link.href=route;
        if(d.head)d.head.appendChild(link);
      }
    });
  },{timeout:3000});
}

// ─── 324. Viewport-Aware Image Priority ───
// Boost priority of above-fold images, deprioritize below-fold
if('IntersectionObserver' in w){
  var imgPrioIO=new IntersectionObserver(function(entries){
    entries.forEach(function(entry){
      var img=entry.target;
      if(entry.isIntersecting){
        if(img.getAttribute('loading')==='lazy'){
          // In viewport — upgrade priority
          img.setAttribute('fetchpriority','high');
          img.removeAttribute('loading');
        }
      }
    });
  },{rootMargin:'0px',threshold:[0]});

  // Observe hero and first-screen images
  onReady(function(){
    d.querySelectorAll('.hero img, section:first-of-type img, [data-hero] img').forEach(function(img){
      imgPrioIO.observe(img);
    });
  });
}

// ─── 325. Smart Fetch Wrapper with Retry ───
NW.fetch=function(url,opts){
  opts=opts||{};
  var retries=opts.retries||2;
  var timeout=opts.timeout||10000;

  function attempt(n){
    var controller,signal,timer;
    if('AbortController' in w){
      controller=new AbortController();
      signal=controller.signal;
      timer=setTimeout(function(){controller.abort();},timeout);
    }
    return fetch(url,Object.assign({},opts,signal?{signal:signal}:{}))
      .then(function(r){if(timer)clearTimeout(timer);return r;})
      .catch(function(e){
        if(timer)clearTimeout(timer);
        if(n>0){
          // Exponential backoff
          return new Promise(function(resolve){
            setTimeout(function(){resolve(attempt(n-1));},1000*(retries-n+1));
          });
        }
        throw e;
      });
  }
  return attempt(retries);
};

// ─── 326. Request Deduplication ───
var inflightRequests=new Map();
NW.deduplicatedFetch=function(url,opts){
  var key=url+JSON.stringify(opts||{});
  if(inflightRequests.has(key)){
    return inflightRequests.get(key);
  }
  var promise=NW.fetch(url,opts).finally(function(){
    inflightRequests.delete(key);
  });
  inflightRequests.set(key,promise);
  return promise;
};

// ─── 327. Bandwidth Estimation ───
NW.estimateBandwidth=function(){
  return new Promise(function(resolve){
    var start=performance.now();
    fetch('/build-info.json',{cache:'no-store'}).then(function(r){
      return r.text();
    }).then(function(text){
      var elapsed=(performance.now()-start)/1000;
      var bytes=new Blob([text]).size;
      var bps=bytes/elapsed;
      NW.measuredBandwidthKBps=Math.round(bps/1024);
      resolve(NW.measuredBandwidthKBps);
    }).catch(function(){resolve(0);});
  });
};

// Measure bandwidth once after load
w.addEventListener('load',function(){
  setTimeout(function(){NW.estimateBandwidth();},3000);
});

// ─── 328-330. Adaptive Image Quality ───
// Serve lower quality images on slow networks
NW.getImageQuality=function(){
  if(NW.strategy==='minimal')return 40;
  if(NW.strategy==='conservative')return 60;
  if(NW.strategy==='aggressive')return 90;
  return 75; // normal
};

// Apply to Next.js Image component quality hints
d.documentElement.style.setProperty('--img-quality',NW.getImageQuality());

// ─── 331-335. Resource Loading Waterfall CSS ───
var nwStyle=d.createElement('style');
nwStyle.textContent=[
  // Minimal strategy: hide non-essential images
  '[data-network-strategy="minimal"] img:not([data-critical]):not(.hero-img){content-visibility:auto;contain-intrinsic-size:auto 200px;}',
  '[data-network-strategy="minimal"] video:not([data-critical]){display:none!important;}',
  '[data-network-strategy="minimal"] iframe:not([data-critical]){display:none!important;}',
  // Conservative: reduce image sizes
  '[data-network-strategy="conservative"] img{image-rendering:auto;}',
  // Aggressive: enable all prefetch animations
  '[data-network-strategy="aggressive"] a[href]:hover{cursor:pointer;}',
].join('\n');
if(d.head)d.head.appendChild(nwStyle);
else onReady(function(){if(d.head)d.head.appendChild(nwStyle);});

// ─── 336-340. Connection Quality Badge (dev only) ───
if(w.location.hostname==='localhost'){
  w.addEventListener('load',function(){
    var badge=d.createElement('div');
    badge.style.cssText='position:fixed;bottom:40px;right:8px;padding:4px 8px;border-radius:6px;font-size:10px;font-family:monospace;z-index:99998;pointer-events:none;opacity:0.7;';
    var colors={minimal:'#ef4444',conservative:'#f59e0b',normal:'#22c55e',aggressive:'#3b82f6'};
    badge.style.background=colors[NW.strategy]||'#666';
    badge.style.color='#fff';
    badge.textContent='NET: '+NW.strategy+' ('+NW.effectiveType+')';
    d.body.appendChild(badge);
    // Update periodically
    setInterval(function(){
      badge.textContent='NET: '+NW.strategy+' ('+(NW.measuredBandwidthKBps||'?')+'KB/s)';
      badge.style.background=colors[NW.strategy]||'#666';
    },5000);
  });
  console.log('%c[NETWORK] Strategy: '+NW.strategy+' | Type: '+NW.effectiveType+' | Downlink: '+NW.downlinkMbps+'Mbps','color:#3b82f6;font-weight:bold');
}
})();
